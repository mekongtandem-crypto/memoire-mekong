<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üêò M√©moire du M√©kong V0.4.12b 2e essai </title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://apis.google.com/js/api.js"></script>
	<script src="https://accounts.google.com/gsi/client"></script>
	<script>
	window.onload = () => {
  		google.accounts.id.initialize({
    		client_id: '82966045106-hso0nr386agcuojllnud0dr41vcsh45a.apps.googleusercontent.com'
  		});
		};
	</script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .lucide { width: 1em; height: 1em; fill: none; stroke: currentColor; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // ===== ICONS LUCIDE =====
        const Home = ({ className = "" }) => <svg className={`lucide ${className}`} viewBox="0 0 24 24"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9,22 9,12 15,12 15,22"/></svg>;
        const Users = ({ className = "" }) => <svg className={`lucide ${className}`} viewBox="0 0 24 24"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="m22 21-2-2"/></svg>;
        const User = ({ className = "" }) => <svg className={`lucide ${className}`} viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>;
        const Play = ({ className = "" }) => <svg className={`lucide ${className}`} viewBox="0 0 24 24"><polygon points="5,3 19,12 5,21"/></svg>;
        const Camera = ({ className = "" }) => <svg className={`lucide ${className}`} viewBox="0 0 24 24"><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></svg>;
        const Cloud = ({ className = "" }) => <svg className={`lucide ${className}`} viewBox="0 0 24 24"><path d="M17.5 19H9a7 7 0 1 1 6.71-9h1.79a4.5 4.5 0 1 1 0 9Z"/></svg>;
        const Settings = ({ className = "" }) => <svg className={`lucide ${className}`} viewBox="0 0 24 24"><path d="M12.22 2h-.44a2 2 0 0 0-2 2.18l.2 1.81c-.26.06-.51.14-.76.23l-1.5-1.16a2 2 0 0 0-2.83.32l-.22.38a2 2 0 0 0 .32 2.83l1.16 1.5c-.09.25-.17.5-.23.76l-1.81.2a2 2 0 0 0-2.18 2v.44a2 2 0 0 0 2.18 2l1.81.2c.06.26.14.51.23.76l-1.16 1.5a2 2 0 0 0-.32 2.83l.38.22a2 2 0 0 0 2.83-.32l1.5-1.16c.25.09.5.17.76.23l.2 1.81a2 2 0 0 0 2 2.18h.44a2 2 0 0 0 2-2.18l.2-1.81c.26-.06.51-.14.76-.23l1.5 1.16a2 2 0 0 0 2.83-.32l.22-.38a2 2 0 0 0-.32-2.83l-1.16-1.5c.09-.25.17-.5.23-.76l1.81-.2a2 2 0 0 0 2.18-2v-.44a2 2 0 0 0-2.18-2l-1.81-.2c-.06-.26-.14-.51-.23-.76l1.16-1.5a2 2 0 0 0 .32-2.83l-.38-.22a2 2 0 0 0-2.83.32l-1.5 1.16c-.25-.09-.5-.17-.76-.23l-.2-1.81a2 2 0 0 0-2-2.18Z"/><circle cx="12" cy="12" r="3"/></svg>;
        const ChevronLeft = ({ className = "" }) => <svg className={`lucide ${className}`} viewBox="0 0 24 24"><path d="m15 18-6-6 6-6"/></svg>;
        const ChevronRight = ({ className = "" }) => <svg className={`lucide ${className}`} viewBox="0 0 24 24"><path d="m9 18 6-6-6-6"/></svg>;
        const Clock = ({ className = "" }) => <svg className={`lucide ${className}`} viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><polyline points="12,6 12,12 16,14"/></svg>;
        const Mic = ({ className = "" }) => <svg className={`lucide ${className}`} viewBox="0 0 24 24"><path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" x2="12" y1="19" y2="22"/><line x1="8" x2="16" y1="22" y2="22"/></svg>;
        const Zap = ({ className = "" }) => <svg className={`lucide ${className}`} viewBox="0 0 24 24"><polygon points="13,2 3,14 12,14 11,22 21,10 12,10"/></svg>;
        const MapPin = ({ className = "" }) => <svg className={`lucide ${className}`} viewBox="0 0 24 24"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg>;
        const BookOpen = ({ className = "" }) => <svg className={`lucide ${className}`} viewBox="0 0 24 24"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>;
        const Edit = ({ className = "" }) => <svg className={`lucide ${className}`} viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="m18.5 2.5 3 3L12 15l-4 1 1-4 9.5-9.5Z"/></svg>;
        const Plus = ({ className = "" }) => <svg className={`lucide ${className}`} viewBox="0 0 24 24"><path d="M5 12h14"/><path d="M12 5v14"/></svg>;
        const Shuffle = ({ className = "" }) => <svg className={`lucide ${className}`} viewBox="0 0 24 24"><polyline points="16,3 21,3 21,8"/><line x1="4" x2="21" y1="20" y2="3"/><polyline points="21,16 21,21 16,21"/><line x1="15" x2="21" y1="15" y2="21"/><line x1="4" x2="9" y1="4" y2="9"/></svg>;
        const Pause = ({ className = "" }) => <svg className={`lucide ${className}`} viewBox="0 0 24 24"><rect width="4" height="16" x="6" y="4"/><rect width="4" height="16" x="14" y="4"/></svg>;
        const ArrowLeft = ({ className = "" }) => <svg className={`lucide ${className}`} viewBox="0 0 24 24"><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>;
        const Send = ({ className = "" }) => <svg className={`lucide ${className}`} viewBox="0 0 24 24"><path d="m22 2-7 20-4-9-9-4Z"/><path d="M22 2 11 13"/></svg>;
        const Trash2 = ({ className = "" }) => <svg className={`lucide ${className}`} viewBox="0 0 24 24"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="m8 6V4c0-1 1-2 2-2h4c0-1-1-2-2-2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>;
        const Search = ({ className = "" }) => <svg className={`lucide ${className}`} viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>;
        const Upload = ({ className = "" }) => <svg className={`lucide ${className}`} viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7,10 12,5 17,10"/><line x1="12" x2="12" y1="5" y2="15"/></svg>;
        const FileText = ({ className = "" }) => <svg className={`lucide ${className}`} viewBox="0 0 24 24"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14,2 14,8 20,8"/><line x1="16" x2="8" y1="13" y2="13"/><line x1="16" x2="8" y1="17" y2="17"/><line x1="10" x2="8" y1="9" y2="9"/></svg>;

		// ===== COMPOSANT TOAST (Alerte) =====
		const Toast = ({ message, type, onDismiss }) => {
    		if (!message) return null;

    		const styles = {
        		error: { bg: 'bg-red-100', text: 'text-red-800', border: 'border-red-300' },
        		success: { bg: 'bg-green-100', text: 'text-green-800', border: 'border-green-300' }
    		};
    		const style = styles[type] || styles.error;

    		return (
        		<div className={`fixed bottom-4 right-4 max-w-sm p-4 border rounded-lg shadow-lg fade-in ${style.bg} ${style.text} ${style.border}`}>
            		<div className="flex justify-between items-center">
                		<span>{message}</span>
                		<button onClick={onDismiss} className="ml-4 text-xl font-bold">&times;</button>
            		</div>
        		</div>
    		);
		};
		
        // ===== CORE STORAGE =====
        // ===== MASTODON DATA MANAGEMENT =====
const MastodonData = {
    // Parser le fichier outbox.json
    parseOutbox: (jsonData) => {
    try {
        const data = typeof jsonData === 'string' ? JSON.parse(jsonData) : jsonData;
        
        // G√©rer la structure ActivityPub compl√®te avec @context
        let orderedItems;
        if (data.orderedItems) {
            orderedItems = data.orderedItems;
        } else if (data.data && data.data.orderedItems) {
            orderedItems = data.data.orderedItems;
        } else {
            throw new Error('Format ActivityPub invalide - orderedItems non trouv√©');
        }

        if (!Array.isArray(orderedItems)) {
            throw new Error('orderedItems n\'est pas un tableau');
        }

        const posts = orderedItems
            .filter(item => item.type === 'Create' && item.object?.type === 'Note')
            .map((item, index) => {
                const note = item.object;
                const content = note.content || '';
                
                // Nettoyer le HTML d'abord
                const cleanContent = content.replace(/<[^>]*>/g, '');
                
                // Extraire le num√©ro de jour - format "Jnnn:" ou "Jnnn "
                const dayMatch = cleanContent.match(/^J(\d{1,3})[\s:]/);
                const dayNumber = dayMatch ? parseInt(dayMatch[1]) : null;
                
                console.log(`Post ${index}: "${cleanContent.slice(0, 50)}" -> Jour: ${dayNumber}`);
                
                return {
                    id: note.id || `post-${index}`,
                    dayNumber,
                    content: cleanContent,
                    published: note.published || item.published,
                    attachments: note.attachment || [],
                    url: note.url
                };
            })
            .filter(post => {
                if (post.dayNumber === null) {
                    console.log(`Post filtr√© (pas de num√©ro): "${post.content.slice(0, 50)}"`);
                }
                return post.dayNumber !== null;
            })
            .sort((a, b) => a.dayNumber - b.dayNumber);

        console.log(`‚úÖ ${posts.length} posts Mastodon import√©s`);
        if (posts.length > 0) {
            console.log(`Plage de jours: ${posts[0].dayNumber} √† ${posts[posts.length-1].dayNumber}`);
        }
        return posts;
    } catch (error) {
        console.error('‚ùå Erreur parsing outbox:', error);
        throw error;
    }
},

    // Sauvegarder les posts
    savePosts: (posts) => {
        Storage.set('mastodon_posts', posts);
        Storage.set('mastodon_imported_at', new Date().toISOString());
    },

    // R√©cup√©rer les posts
    getPosts: () => {
        return Storage.get('mastodon_posts', []);
    },

    // Rechercher dans les posts
    searchPosts: (query) => {
        const posts = MastodonData.getPosts();
        if (!query.trim()) return posts;
        
        const searchTerms = query.toLowerCase().trim().split(/\s+/);
        return posts.filter(post => 
            searchTerms.every(term => 
                post.content.toLowerCase().includes(term)
            )
        );
    },

    // Obtenir un post par num√©ro de jour
    getPostByDay: (dayNumber) => {
        const posts = MastodonData.getPosts();
        return posts.find(post => post.dayNumber === dayNumber);
    },

    // Obtenir un post al√©atoire
    getRandomPost: () => {
        const posts = MastodonData.getPosts();
        if (posts.length === 0) return null;
        return posts[Math.floor(Math.random() * posts.length)];
    },

    // V√©rifier si les donn√©es sont import√©es
    isImported: () => {
        const posts = MastodonData.getPosts();
        return posts.length > 0;
    },

    // Obtenir les stats
    getStats: () => {
        const posts = MastodonData.getPosts();
        const importedAt = Storage.get('mastodon_imported_at');
        return {
            totalPosts: posts.length,
            dayRange: posts.length > 0 ? {
                min: Math.min(...posts.map(p => p.dayNumber)),
                max: Math.max(...posts.map(p => p.dayNumber))
            } : null,
            importedAt
        };
    }
};
        const Storage = {
            get: (key, defaultValue = null) => {
                try {
                    const item = localStorage.getItem(`mekong_${key}`);
                    return item ? JSON.parse(item) : defaultValue;
                } catch { return defaultValue; }
            },
            set: (key, value) => {
                try {
                    localStorage.setItem(`mekong_${key}`, JSON.stringify(value));
                    return true;
                } catch { return false; }
            },
            remove: (key) => localStorage.removeItem(`mekong_${key}`),
            clear: () => {
                Object.keys(localStorage).forEach(key => {
                    if (key.startsWith('mekong_')) localStorage.removeItem(key);
                });
            }
};

// ===== GOOGLE DRIVE API - VERSION 2024 =====
const GOOGLE_CONFIG = {
    API_KEY: 'AIzaSyDiyLLN4EsyVREGxF4TzqbuKyugaq4TUXw',
    CLIENT_ID: '82966045106-hso0nr386agcuojllnud0dr41vcsh45a.apps.googleusercontent.com',
    // Revenir au scope drive.file qui est moins sensible
    SCOPES: 'https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/userinfo.profile https://www.googleapis.com/auth/userinfo.email'
};
		
const GoogleDriveAPI = {
    isSignedIn: false,
    isInitialized: false,
    tokenClient: null,
    
    async init() {
        if (this.isInitialized) return;
        
        try {
            console.log('üîÑ Initialisation Google Drive API...');
            console.log('Config:', GOOGLE_CONFIG); // Debug
            
            await new Promise((resolve) => {
                gapi.load('client', resolve);
            });
            
            await gapi.client.init({
                apiKey: GOOGLE_CONFIG.API_KEY,
                discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest']
            });
            
            this.tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: GOOGLE_CONFIG.CLIENT_ID,
                scope: GOOGLE_CONFIG.SCOPES,
                callback: '' // Sera d√©fini dynamiquement
            });
            
            this.isInitialized = true;
            console.log('‚úÖ Google Drive API initialis√©e (version 2024)');
        } catch (error) {
            console.error('‚ùå Erreur init Google Drive API:', error);
            throw error;
        }
    },
    
    async signIn() {
        if (!this.isInitialized) await this.init();
        
        return new Promise((resolve, reject) => {
            if (!this.tokenClient) {
                reject(new Error('Token client non initialis√©'));
                return;
            }
            
            this.tokenClient.callback = async (response) => {
                if (response.error) {
                    console.error('‚ùå Erreur OAuth:', response);
                    this.isSignedIn = false;
                    reject(new Error(`Erreur OAuth: ${response.error}`));
                    return;
                }
                
                console.log('‚úÖ Token OAuth re√ßu');
                
                try {
                    // Attendre un peu pour que le token soit bien appliqu√©
                    await new Promise(resolve => setTimeout(resolve, 200));
                    
                    await gapi.client.drive.files.list({ pageSize: 1 });
                    console.log('‚úÖ API Drive fonctionnelle');
                    this.isSignedIn = true;
                    resolve(true);
                } catch (error) {
                    console.error('‚ùå Test API Drive √©chou√©:', error);
                    this.isSignedIn = false;
                    reject(new Error('Acc√®s API Drive impossible - Permissions insuffisantes'));
                }
            };
            
            const token = gapi.client.getToken();
            if (token) {
                console.log('üîÑ Token existant trouv√©, test de validit√©...');
                gapi.client.drive.files.list({ pageSize: 1 })
                    .then(() => {
                        this.isSignedIn = true;
                        console.log('‚úÖ Token existant valide');
                        resolve(true);
                    })
                    .catch(() => {
                        console.log('üîÑ Token expir√©, demande de nouveau token...');
                        gapi.client.setToken(''); // Clear le token invalide
                        this.tokenClient.requestAccessToken({ prompt: 'consent' });
                    });
            } else {
                console.log('üîÑ Aucun token, demande d\'autorisation avec consentement...');
                // Forcer le consentement d√®s la premi√®re demande pour avoir les bons scopes
                this.tokenClient.requestAccessToken({ prompt: 'consent' });
            }
        });
    },
    
    async signOut() {
        const token = gapi.client.getToken();
        if (token) {
            google.accounts.oauth2.revoke(token.access_token);
            gapi.client.setToken('');
        }
        this.isSignedIn = false;
        console.log('‚úÖ D√©connect√© de Google Drive');
    },
    
    async findMekongFile() {
        if (!this.isSignedIn) return null;
        try {
            const response = await gapi.client.drive.files.list({
                q: "name='mekong_sessions.json' and trashed=false",
                fields: 'files(id, name)'
            });
            return response.result.files[0] || null;
        } catch (error) {
            console.error('‚ùå Erreur recherche fichier:', error);
            return null;
        }
    },
    
    async saveSessions(sessions) {
        console.log('üîÑ D√©but saveSessions, isSignedIn:', this.isSignedIn);
        
        if (!this.isSignedIn) {
            console.warn('‚ö†Ô∏è Pas connect√© - sauvegarde locale uniquement');
            return false;
        }
        
        try {
            console.log('üîÑ Pr√©paration des donn√©es...');
            const data = JSON.stringify({ 
                sessions, 
                lastUpdated: new Date().toISOString(),
                version: '0.4.12b'
            }, null, 2);
            
            console.log('üîÑ Recherche fichier existant...');
            const existingFile = await this.findMekongFile();
            console.log('üìÅ Fichier existant:', existingFile);
            
            if (existingFile) {
                console.log('üîÑ Mise √† jour fichier existant...');
                const response = await gapi.client.request({
                    path: `https://www.googleapis.com/upload/drive/v3/files/${existingFile.id}`,
                    method: 'PATCH',
                    params: { uploadType: 'media' },
                    headers: { 'Content-Type': 'application/json' },
                    body: data
                });
                console.log('‚úÖ Sessions sauvegard√©es (MAJ)', response);
                return true;
            } else {
                console.log('üîÑ Cr√©ation nouveau fichier...');
                
                // L'ancien bloc 'try' interne a √©t√© retir√© ici.
                // Le 'catch' principal s'occupe d√©j√† de la gestion des erreurs.
                const boundary = '-------314159265358979323846';
                const delimiter = "\r\n--" + boundary + "\r\n";
                const close_delim = "\r\n--" + boundary + "--";

                const metadata = {
                    'name': 'mekong_sessions.json',
                    'mimeType': 'application/json'
                };

                const multipartRequestBody =
                    delimiter +
                    'Content-Type: application/json\r\n\r\n' +
                    JSON.stringify(metadata) +
                    delimiter +
                    'Content-Type: application/json\r\n\r\n' +
                    data +
                    close_delim;

                const response = await gapi.client.request({
                    'path': 'https://www.googleapis.com/upload/drive/v3/files',
                    'method': 'POST',
                    'params': {'uploadType': 'multipart'},
                    'headers': {
                        'Content-Type': 'multipart/related; boundary="' + boundary + '"'
                    },
                    'body': multipartRequestBody
                });
                console.log('‚úÖ Sessions sauvegard√©es (NOUVEAU - multipart)', response);
                return true;
            }
        } catch (error) {
            console.error('‚ùå Erreur sauvegarde d√©taill√©e:', error);
            console.error('‚ùå Status:', error.status);
            console.error('‚ùå Body:', error.body);
            console.error('‚ùå Details:', error.result);
            return false;
        }
    },
    
    async loadSessions() {
        if (!this.isSignedIn) return null;
        
        try {
            const file = await this.findMekongFile();
            if (!file) return null;
            
            const response = await gapi.client.drive.files.get({
                fileId: file.id,
                alt: 'media'
            });
            
            const data = JSON.parse(response.body);
            console.log('‚úÖ Sessions charg√©es depuis Google Drive');
            return data.sessions || [];
        } catch (error) {
            console.error('‚ùå Erreur chargement:', error);
            return null;
        }
    }
};
// ===== USER CONFIG =====
        const USERS = {
            tom: { name: 'Tom l\'√©l√©phanteau', color: 'blue', emoji: 'üêò' },
            lambert: { name: 'Lambert, le Vieil √©l√©phant', color: 'green', emoji: 'üêò' },
            duo: { name: 'Duo Mekong Tandem', color: 'amber', emoji: 'üêòüêò' }
        };

        const getUserStyle = (userKey) => {
            const user = USERS[userKey];
            if (!user) return { bg: 'bg-gray-100', border: 'border-gray-300', text: 'text-gray-800' };
            
            const styles = {
                blue: { bg: 'bg-blue-100 hover:bg-blue-200', border: 'border-blue-300', text: 'text-blue-800' },
                green: { bg: 'bg-green-100 hover:bg-green-200', border: 'border-green-300', text: 'text-green-800' },
                amber: { bg: 'bg-amber-100 hover:bg-amber-200', border: 'border-amber-300', text: 'text-amber-800' }
            };
            return styles[user.color] || styles.blue;
        };

        // ===== CORE STATES =====
        // ===== CORE STATES =====
        const useAppState = () => {
            const [currentPage, setCurrentPage] = React.useState('home');
            const [currentUser, setCurrentUser] = React.useState(Storage.get('currentUser', ''));
            
            // Sauvegarde automatique
            React.useEffect(() => {
                Storage.set('currentUser', currentUser);
            }, [currentUser]);

            const resetApp = () => {
                setCurrentPage('home');
                setCurrentUser('');
                Storage.clear();
            };

            return {
                currentPage, setCurrentPage,
                currentUser, setCurrentUser,
                resetApp
            };
        };

        
        // ===== PAGE USERS =====
        const UsersPage = ({ currentUser, onUserChange, onPageChange }) => {
            return (
                <div className="space-y-6 fade-in">
                    <div className="text-center mb-6">
                        <h2 className="text-2xl font-bold text-amber-900 mb-2">Gestion des Utilisateurs</h2>
                        <p className="text-amber-700">
                            Actuellement connect√© en tant que <strong>{USERS[currentUser]?.name}</strong>
                        </p>
                    </div>

                    <div className="space-y-4">
                        <h3 className="text-lg font-semibold text-amber-900">Changer d'utilisateur :</h3>
                        
                        <div className="grid grid-cols-1 gap-4">
                            {Object.entries(USERS).map(([key, user]) => (
                                <button
                                    key={key}
                                    onClick={() => {
                                        onUserChange(key);
                                        onPageChange('home');
                                    }}
                                    className={`flex items-center space-x-4 p-4 border-2 rounded-lg transition-all ${
                                        key === currentUser 
                                            ? `${getUserStyle(key).bg} ${getUserStyle(key).border} ring-2 ring-amber-300` 
                                            : `${getUserStyle(key).bg} hover:${getUserStyle(key).border} border-gray-200 hover:border-amber-300`
                                    }`}
                                >
                                    <span className="text-3xl">{user.emoji}</span>
                                    <div className="flex-1 text-left">
                                        <div className={`font-semibold text-lg ${getUserStyle(key).text}`}>
                                            {user.name}
                                            {key === currentUser && (
                                                <span className="ml-2 text-sm bg-amber-200 text-amber-800 px-2 py-1 rounded-full">
                                                    Actuel
                                                </span>
                                            )}
                                        </div>
                                        <div className="text-sm text-gray-600">
                                            {key === 'tom' && "Le jeune aventurier"}
                                            {key === 'lambert' && "Le sage guide"}  
                                            {key === 'duo' && "Session p√®re-fils"}
                                        </div>
                                    </div>
                                    {key !== currentUser && (
                                        <div className="text-amber-600 font-medium">‚Üí Changer</div>
                                    )}
                                </button>
                            ))}
                        </div>
                    </div>

                    <div className="bg-amber-50 border border-amber-200 rounded-lg p-4 mt-6">
                        <h4 className="font-semibold text-amber-900 mb-2">üí° √Ä propos des utilisateurs</h4>
                        <div className="text-amber-700 text-sm space-y-1">
                            <div><strong>Tom :</strong> Voit ses propres messages √† droite, ceux de Lambert √† gauche</div>
                            <div><strong>Lambert :</strong> Voit ses propres messages √† droite, ceux de Tom √† gauche</div>
                            <div><strong>Duo :</strong> Mode session partag√©e, messages centr√©s</div>
                        </div>
                    </div>

                    <div className="flex justify-center pt-4">
                        <button
                            onClick={() => onPageChange('home')}
                            className="px-6 py-3 bg-amber-500 hover:bg-amber-600 text-white rounded-lg font-medium"
                        >
                            Retour √† l'accueil
                        </button>
                    </div>
                </div>
            );
        };

        // ===== GAMES CATALOG =====
        const GAMES = [
            { 
                id: 1, 
                title: "Photo roulette", 
                duration: "15 min", 
                type: "pr√©sentiel",
                icon: Camera, 
                description: "S√©lectionnez une photo au hasard et racontez tout ce qui vous revient en m√©moire" 
            },
            { 
                id: 2, 
                title: "Timeline aveugle", 
                duration: "20 min", 
                type: "pr√©sentiel",
                icon: Clock, 
                description: "Reconstituez la chronologie d'une √©tape sans regarder les dates" 
            },
            { 
                id: 3, 
                title: "Interview journaliste", 
                duration: "25 min", 
                type: "pr√©sentiel",
                icon: Mic, 
                description: "L'un interviewe l'autre sur une √©tape pr√©cise du voyage" 
            },
            { 
                id: 4, 
                title: "Photo sans l√©gende", 
                duration: "async", 
                type: "distanciel",
                icon: Camera, 
                description: "Envoyez une photo, l'autre devine le contexte et ses souvenirs" 
            },
            { 
                id: 5, 
                title: "Mot d√©clencheur", 
                duration: "async", 
                type: "distanciel",
                icon: Zap, 
                description: "Un mot-cl√© pour d√©clencher un souvenir chez l'autre" 
            },
            { 
                id: 6, 
                title: "G√©olocalisation myst√®re", 
                duration: "async", 
                type: "distanciel",
                icon: MapPin, 
                description: "Partagez une position GPS, l'autre raconte ce lieu" 
            },
            { 
                id: 7, 
                title: "Souvenir du jour", 
                duration: "libre", 
                type: "m√©moire",
                icon: BookOpen, 
                description: "Discussion autour d'un post sp√©cifique du blog Mastodon" 
            }
        ];

// ===== CLOUD SESSION STORAGE (Modifi√© pour les erreurs) =====
const CloudSessionStorage = {
    async getSessions() {
        try {
            if (!GoogleDriveAPI.isSignedIn) {
                console.log('üì± Pas connect√© au cloud, utilisation cache local');
                return Storage.get('sessions', []);
            }
            
            const cloudSessions = await GoogleDriveAPI.loadSessions();
            if (cloudSessions) {
                Storage.set('sessions', cloudSessions);
                console.log(`‚úÖ ${cloudSessions.length} sessions charg√©es depuis Google Drive`);
                return cloudSessions;
            }
        } catch (error) {
            console.warn('‚ö†Ô∏è Erreur chargement cloud:', error.message);
        }
        return Storage.get('sessions', []);
    },
    
    async saveSession(session) {
        // R√©cup√©rer toutes les sessions
        const sessions = Storage.get('sessions', []);
        
        // Mettre √† jour ou ajouter la session
        const existingIndex = sessions.findIndex(s => s.id === session.id);
        if (existingIndex >= 0) {
            sessions[existingIndex] = session;
        } else {
            sessions.unshift(session);
        }
        
        // Sauvegarder localement
        Storage.set('sessions', sessions);
        
        // Sauvegarder dans le cloud si connect√©
        if (!GoogleDriveAPI.isSignedIn) {
            console.log('üì± Session sauvegard√©e localement (cloud d√©connect√©)');
            return;
        }
        
        try {
            await GoogleDriveAPI.saveSessions(sessions);
            console.log('‚úÖ Session sauvegard√©e localement + cloud');
        } catch (error) {
            console.warn('‚ö†Ô∏è Erreur sauvegarde cloud:', error.message);
            throw new Error(`Sauvegarde cloud √©chou√©e: ${error.message}. Session sauvegard√©e localement.`);
        }
    },
    
    async deleteSession(sessionId) {
        const sessions = Storage.get('sessions', []).filter(s => s.id !== sessionId);
        Storage.set('sessions', sessions);
        
        if (!GoogleDriveAPI.isSignedIn) {
            console.log('üóëÔ∏è Session supprim√©e localement (cloud d√©connect√©)');
            return;
        }
        
        try {
            await GoogleDriveAPI.saveSessions(sessions);
            console.log('‚úÖ Session supprim√©e localement + cloud');
        } catch (error) {
            console.warn('‚ö†Ô∏è Erreur suppression cloud:', error.message);
            throw new Error(`Suppression cloud √©chou√©e: ${error.message}. Session supprim√©e localement.`);
        }
    },

    async forceSyncFromCloud() {
        if (!GoogleDriveAPI.isSignedIn) {
            throw new Error('Non connect√© √† Google Drive');
        }
        
        try {
            const cloudSessions = await GoogleDriveAPI.loadSessions();
            if (cloudSessions) {
                Storage.set('sessions', cloudSessions);
                console.log(`üîÑ ${cloudSessions.length} sessions synchronis√©es depuis Google Drive`);
                return cloudSessions;
            } else {
                console.log('üìÅ Aucune donn√©e cloud trouv√©e');
                return Storage.get('sessions', []);
            }
        } catch (error) {
            console.error('‚ùå Erreur synchronisation:', error);
            throw new Error(`√âchec synchronisation: ${error.message}`);
        }
    }
};

// ===== SESSION STORAGE =====
        const SessionStorage = {
            getSessions: () => {
    			const sessions = Storage.get('sessions', []);
    			// Nettoyer les sessions corrompues
    			return sessions.filter(session => {
        			const isValid = session && 
                       			typeof session.id !== 'undefined' && 
                       			typeof session.gameId === 'number' && 
                       			session.gameId > 0 &&
                       			Array.isArray(session.notes);
        			if (!isValid) {
            			console.warn('Session corrompue supprim√©e:', session);
        			}
        			return isValid;
    			});
			},
            saveSession: (session) => {
                const sessions = SessionStorage.getSessions();
                const existingIndex = sessions.findIndex(s => s.id === session.id);
                if (existingIndex >= 0) {
                    sessions[existingIndex] = session;
                } else {
                    sessions.unshift(session);
                }
                Storage.set('sessions', sessions);
            },
            deleteSession: (sessionId) => {
                const sessions = SessionStorage.getSessions().filter(s => s.id !== sessionId);
                Storage.set('sessions', sessions);
            }
        };

        // ===== SESSION HELPERS =====
        const getGameIcon = (gameId) => {
            if (!gameId || typeof gameId !== 'number') {
                console.log('getGameIcon: gameId invalide', gameId);
                return BookOpen; // S√©curit√© si gameId undefined/invalide
            }
            const game = GAMES.find(g => g.id === gameId);
            if (!game) {
                console.log('getGameIcon: jeu non trouv√© pour gameId', gameId);
                return BookOpen;
            }
            return game.icon;
        };

        const renderGameIcon = (gameId, className = "w-6 h-6 text-amber-600") => {
    		try {
        		const game = GAMES.find(g => g.id === gameId);
        		if (!game || !game.icon) {
            		console.warn('renderGameIcon: Jeu non trouv√© pour gameId:', gameId);
            		return React.createElement(BookOpen, { className });
        		}
        
        		const IconComponent = game.icon;
        		if (typeof IconComponent !== 'function') {
            		console.warn('renderGameIcon: Icon n\'est pas une fonction:', IconComponent);
            		return React.createElement(BookOpen, { className });
        		}
        
        		return React.createElement(IconComponent, { className });
    		} catch (error) {
        		console.error('renderGameIcon: Erreur lors du rendu:', error);
        		return React.createElement(BookOpen, { className });
    		}
		};

        const getGameById = (gameId) => {
            return GAMES.find(g => g.id === gameId);
        };

// ===== SESSION HOOKS (L√âG√àRE MODIFICATION) =====
const useSessionState = () => {
    const [currentSession, setCurrentSession] = React.useState(null);
    const [sessions, setSessions] = React.useState([]);

    React.useEffect(() => {
        const loadSessions = async () => {
            const loadedSessions = await CloudSessionStorage.getSessions();
            setSessions(loadedSessions);
        };
        loadSessions();
    }, []);

    const createSession = async (game, user) => {
        console.log('createSession appel√©e avec:', { game, user });

        if (!game || !game.id) {
            console.error('createSession: jeu invalide', game);
            return;
        }

        const newSession = {
            id: Date.now(),
            gameId: Number(game.id), // S'assurer que c'est un nombre
            gameTitle: game.title || 'Titre inconnu',
            gameDescription: game.description || 'Description inconnue',
            gameDuration: game.duration || 'Dur√©e inconnue',
            postChapo: window.pendingGameSession?.postChapo || null, // Chapo du post
            user: user,
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString(),
            status: 'active',
            notes: [], // S'assurer que notes est toujours un tableau
            participants: [user]
            // NE PAS sauvegarder gameIcon - on le r√©cup√®rera depuis GAMES
        };

        console.log('Nouvelle session cr√©√©e:', newSession);

        await CloudSessionStorage.saveSession(newSession);
        const sessions = await CloudSessionStorage.getSessions();
        setSessions(sessions);
        setCurrentSession(newSession);
        
        // Nettoyer la session en attente
        if (window.pendingGameSession) {
            delete window.pendingGameSession;
        }
        
        return newSession;
    };

    const updateSession = async (updatedSession) => {
        const sessionToSave = {
            ...updatedSession, 
            notes: updatedSession.notes || [],
            updatedAt: new Date().toISOString()
        };
        // L√®ve une erreur si le cloud √©choue, qui sera attrap√©e par l'UI
        await CloudSessionStorage.saveSession(sessionToSave);
        const newSessions = await CloudSessionStorage.getSessions();
        setSessions(newSessions);
        setCurrentSession(sessionToSave);
    };

    const deleteSession = async (sessionId) => {
        await CloudSessionStorage.deleteSession(sessionId);
        const sessions = await CloudSessionStorage.getSessions();
        setSessions(sessions);
        if (currentSession?.id === sessionId) {
            setCurrentSession(null);
        }
    };
    
    const syncSessions = React.useCallback(async () => {
        try {
            const syncedSessions = await CloudSessionStorage.forceSyncFromCloud();
            setSessions(syncedSessions);
            return syncedSessions;
        } catch (error) {
            console.error('Erreur sync:', error);
            throw error;
        }
    }, []); // Pas de d√©pendances pour √©viter la boucle

    return {
        currentSession, setCurrentSession,
        sessions, setSessions, // On expose setSessions
        createSession,
        updateSession,
        deleteSession,
        getGameIcon,
        renderGameIcon,
        syncSessions
    };
};


// ===== GOOGLE AUTH HOOK (CORRIG√â) =====
const useGoogleAuth = () => {
    const [isConnected, setIsConnected] = React.useState(false);
    const [isLoading, setIsLoading] = React.useState(true);
    const [userInfo, setUserInfo] = React.useState(null);
    const [shouldForceConnection, setShouldForceConnection] = React.useState(false);

    React.useEffect(() => {
        const initGoogle = async () => {
            setIsLoading(true);
            try {
                await GoogleDriveAPI.init();
                
                const token = gapi.client.getToken();
                if (token) {
                    try {
                        // Tester avec un d√©lai pour laisser le token s'initialiser
                        await new Promise(resolve => setTimeout(resolve, 100));
                        await gapi.client.drive.files.list({ pageSize: 1 });
                        
                        const response = await fetch('https://www.googleapis.com/oauth2/v3/userinfo', {
                            headers: { 'Authorization': `Bearer ${token.access_token}` }
                        });
                        
                        if (response.ok) {
                            const profile = await response.json();
                            setUserInfo({
                                name: profile.name,
                                email: profile.email,
                                picture: profile.picture
                            });
                            setIsConnected(true);
                            GoogleDriveAPI.isSignedIn = true;
                            console.log('‚úÖ Reconnexion automatique r√©ussie');
                        } else {
                            throw new Error('Token invalide');
                        }
                    } catch (error) {
                        console.log('‚ö†Ô∏è Token expir√©, reconnexion n√©cessaire');
                        gapi.client.setToken(''); // Clear le token invalide
                        setShouldForceConnection(true);
                    }
                } else {
                    // Pas de token, forcer la connexion
                    setShouldForceConnection(true);
                }
            } catch (error) {
                console.error('Erreur init Google:', error);
                setShouldForceConnection(true);
            } finally {
                setIsLoading(false);
            }
        };
        initGoogle();
    }, []);

    const signIn = async () => {
        setIsLoading(true);
        try {
            const success = await GoogleDriveAPI.signIn();
            if (success) {
                const token = gapi.client.getToken();
                const response = await fetch('https://www.googleapis.com/oauth2/v3/userinfo', {
                    headers: { 'Authorization': `Bearer ${token.access_token}` }
                });
                
                if (!response.ok) {
                    throw new Error('Impossible de r√©cup√©rer le profil utilisateur');
                }
                
                const profile = await response.json();
                setUserInfo({
                    name: profile.name,
                    email: profile.email,
                    picture: profile.picture
                });
                setIsConnected(true);
                setShouldForceConnection(false);
                console.log('Connexion r√©ussie:', profile.name);
                return true;
            } else {
                throw new Error('√âchec de la connexion Google Drive');
            }
        } catch (error) {
            console.error('Erreur connexion:', error);
            setIsConnected(false);
            setUserInfo(null);
            alert(`Erreur de connexion: ${error.message}`);
            return false;
        } finally {
            setIsLoading(false);
        }
    };

    const signOut = async () => {
        setIsLoading(true); // Afficher le loading pendant la d√©connexion
        
        try {
            const token = gapi.client.getToken();
            if (token) {
                google.accounts.oauth2.revoke(token.access_token);
                gapi.client.setToken('');
            }
            await GoogleDriveAPI.signOut();
            
            // Forcer la mise √† jour des √©tats
            setIsConnected(false);
            setUserInfo(null);
            setShouldForceConnection(true);
            
            console.log('‚úÖ D√©connexion r√©ussie');
        } catch (error) {
            console.error('Erreur d√©connexion:', error);
        } finally {
            setIsLoading(false); // Arr√™ter le loading
        }
    };

    return { isConnected, isLoading, userInfo, shouldForceConnection, signIn, signOut };
};



// ===== NAVIGATION : COMPOSANT TOP BAR 1 ligne (Version 2.1 - Boutons agrandis) =====
const TopBar = ({ currentPage, currentUser, onUserChange, onPageChange, googleStatus, onGoogleAction }) => {
    const PAGE_TITLES = {
        home: "M√©moire du M√©kong",
        sessions: "Vos Sessions", 
        games: "Choisir un jeu",
        chat: "Conversation",
        memories: "M√©moires du Voyage",
        settings: "R√©glages",
        users: "Gestion des Utilisateurs"
    };

    return (
        <header className="sticky top-0 z-10 p-3 bg-white/90 backdrop-blur-md border-b border-gray-200">
            <div className="flex justify-between items-center h-10">
                <h1 className="text-xl font-bold text-amber-900 truncate">
                    {PAGE_TITLES[currentPage] || "M√©moire du M√©kong"}
                </h1>
                <div className="flex items-center space-x-2">
                    <button
                        onClick={onGoogleAction}
                        className={`flex items-center justify-center h-10 px-3 rounded-lg text-xs font-medium transition-colors ${
                            googleStatus?.isLoading ? 'bg-blue-100 text-blue-700 cursor-wait'
                            : googleStatus?.isConnected ? 'bg-green-100 text-green-700 hover:bg-green-200'
                            : 'bg-red-100 text-red-700 hover:bg-red-200'
                        }`}
                        title={googleStatus?.isConnected ? `Connect√©: ${googleStatus.userInfo?.email}` : 'Non connect√©'}
                    >
                        {googleStatus?.isLoading
                            ? <div className="animate-spin w-4 h-4 border-2 border-blue-600 border-t-transparent rounded-full"></div>
                            : <Cloud className="w-5 h-5" />
                        }
                    </button>
                    {currentUser && (
                         <button
                            onClick={() => onPageChange('users')}
                            className={`flex items-center justify-center w-10 h-10 rounded-full border ${getUserStyle(currentUser).bg} ${getUserStyle(currentUser).border}`}
                            title={`Connect√© en tant que ${USERS[currentUser]?.name}. Cliquer pour g√©rer les utilisateurs.`}
                        >
                            <span className="text-xl">{USERS[currentUser]?.emoji}</span>
                        </button>
                    )}
                </div>
            </div>
        </header>
    );
};

// ===== NOUVEAU COMPOSANT : BOTTOM NAV BAR (Version √† 4 ic√¥nes) =====
const BottomNavBar = ({ currentPage, onPageChange, currentUser }) => {
    const navItems = [
        { id: 'home', icon: Home, label: 'Accueil' },
        { id: 'sessions', icon: BookOpen, label: 'Sessions' },
        { id: 'memories', icon: Cloud, label: 'M√©moires' },
        { id: 'settings', icon: Settings, label: 'R√©glages' },
    ];

    return (
        <div className="fixed bottom-0 left-0 right-0 h-16 bg-white/90 backdrop-blur-md border-t border-gray-200 shadow-t-lg z-10">
            <div className="flex justify-around items-center h-full">
                {navItems.map((item) => {
                    const Icon = item.icon;
                    const isActive = currentPage === item.id;
                    const isDisabled = !currentUser && item.id !== 'home';
                    
                    return (
                        <button
                            key={item.id}
                            onClick={() => onPageChange(item.id)}
                            disabled={isDisabled}
                            className={`flex flex-col items-center justify-center w-full h-full transition-colors duration-200 ${
                                isActive ? 'text-amber-600' : 'text-gray-500 hover:text-amber-500'
                            } ${isDisabled ? 'opacity-40 cursor-not-allowed' : ''}`}
                        >
                            <Icon className="w-6 h-6 mb-1" />
                            <span className={`text-xs font-medium ${isActive ? 'font-bold' : ''}`}>
                                {item.label}
                            </span>
                        </button>
                    );
                })}
            </div>
        </div>
    );
};

// ==================== FIN DE LA SECTION NAVIGATION √Ä AJOUTER ====================
     

// ===== GOOGLE CONNECTION COMPONENT =====
const GoogleConnection = ({ isConnected, isLoading, userInfo, onSignIn, onSignOut }) => {
    if (isLoading) {
        return (
            <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                <div className="flex items-center space-x-3">
                    <div className="animate-spin w-5 h-5 border-2 border-blue-600 border-t-transparent rounded-full"></div>
                    <span className="text-blue-700">Connexion Google Drive...</span>
                </div>
            </div>
        );
    }

    if (!isConnected) {
        return (
            <div className="bg-red-50 border border-red-200 rounded-lg p-4 mb-4">
                <div className="flex items-center justify-between">
                    <div className="flex items-center space-x-3">
                        <div className="w-8 h-8 bg-red-100 rounded-full flex items-center justify-center">
                            <Cloud className="w-4 h-4 text-red-600" />
                        </div>
                        <div>
                            <div className="font-medium text-red-900">Connexion Google Drive requise</div>
                            <div className="text-sm text-red-700">Vos sessions seront partag√©es avec Tom/Lambert</div>
                        </div>
                    </div>
                    <button
                        onClick={onSignIn}
                        className="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg text-sm font-medium"
                    >
                        Se connecter
                    </button>
                </div>
            </div>
        );
    }

    return (
        <div className="bg-green-50 border border-green-200 rounded-lg p-3 mb-4">
            <div className="flex items-center justify-between">
                <div className="flex items-center space-x-3">
                    <div className="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center">
                        <Cloud className="w-4 h-4 text-green-600" />
                    </div>
                    <div>
                        <div className="font-medium text-green-900">Connect√© √† Google Drive</div>
                        <div className="text-xs text-green-700">{userInfo?.email}</div>
                    </div>
                </div>
                <button
                    onClick={onSignOut}
                    className="px-3 py-1 bg-green-600 hover:bg-green-700 text-white rounded text-xs"
                >
                    D√©connecter
                </button>
            </div>
        </div>
    );
};


// ===== COMPOSANT CONNEXION OBLIGATOIRE =====
const ForceGoogleConnection = ({ onSignIn }) => (
    <div className="min-h-screen bg-gradient-to-br from-amber-50 to-orange-100 flex items-center justify-center p-4">
        <div className="bg-white rounded-xl shadow-lg p-8 max-w-md w-full text-center">
            <div className="w-16 h-16 bg-amber-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <Cloud className="w-8 h-8 text-amber-600" />
            </div>
            <h1 className="text-2xl font-bold text-amber-900 mb-4">M√©moire du M√©kong</h1>
            <h2 className="text-lg font-semibold text-gray-900 mb-4">Connexion Google Drive requise</h2>
            <p className="text-gray-600 mb-6">
                Cette application utilise Google Drive pour synchroniser vos sessions entre vos appareils. 
                La connexion est obligatoire pour garantir la sauvegarde de vos m√©moires.
            </p>
            <div className="bg-amber-50 border border-amber-200 rounded-lg p-4 mb-6">
                <p className="text-amber-800 text-sm">
                    <strong>Conseil :</strong> Connectez-vous avec le compte Google partag√© 
                    <strong> mekongmemoire@gmail.com</strong> pour synchroniser avec Tom/Lambert.
                </p>
            </div>
            <button
                onClick={onSignIn}
                className="w-full px-6 py-3 bg-amber-600 hover:bg-amber-700 text-white rounded-lg font-medium flex items-center justify-center space-x-2"
            >
                <Cloud className="w-5 h-5" />
                <span>Se connecter √† Google Drive</span>
            </button>
        </div>
    </div>
);

        // ===== MAIN PAGES =====


        // ===== MAIN PAGES =====
        const HomePage = ({ currentUser, onUserChange, onPageChange }) => (
            <div className="space-y-6 fade-in">
                <div className="text-center">
                    <h2 className="text-2xl font-bold text-amber-900 mb-4">
                        Bienvenue dans vos m√©moires du M√©kong
                    </h2>
                    {currentUser && (
                        <p className="text-amber-700 mb-6">
                            Bonjour <strong>{USERS[currentUser]?.name}</strong> ! Que souhaitez-vous faire aujourd'hui ?
                        </p>
                    )}
                </div>

                {!currentUser ? (
                    <div className="max-w-md mx-auto space-y-4">
                        <h3 className="text-lg font-semibold text-amber-900 text-center">Qui √™tes-vous ?</h3>
                        <div className="space-y-3">
                            <button
                                onClick={() => onUserChange('tom')}
                                className={`flex items-center space-x-3 p-4 border-2 rounded-lg w-full text-left transition-all ${getUserStyle('tom').bg} hover:${getUserStyle('tom').border}`}
                            >
                                <span className="text-3xl">üêò</span>
                                <div>
                                    <div className={`font-medium text-lg ${getUserStyle('tom').text}`}>Tom l'√©l√©phantau</div>
                                    <div className="text-sm text-gray-600">Le jeune aventurier</div>
                                </div>
                            </button>
                            <button
                                onClick={() => onUserChange('lambert')}
                                className={`flex items-center space-x-3 p-4 border-2 rounded-lg w-full text-left transition-all ${getUserStyle('lambert').bg} hover:${getUserStyle('lambert').border}`}
                            >
                                <span className="text-3xl">üêò</span>
                                <div>
                                    <div className={`font-medium text-lg ${getUserStyle('lambert').text}`}>Lambert, le Vieil √©l√©phant</div>
                                    <div className="text-sm text-gray-600">Le sage guide</div>
                                </div>
                            </button>
                            <button
                                onClick={() => onUserChange('duo')}
                                className={`flex items-center space-x-3 p-4 border-2 rounded-lg w-full text-left transition-all ${getUserStyle('duo').bg} hover:${getUserStyle('duo').border}`}
                            >
                                <span className="text-3xl">üêòüêò</span>
                                <div>
                                    <div className={`font-medium text-lg ${getUserStyle('duo').text}`}>Duo Mekong Tandem</div>
                                    <div className="text-sm text-gray-600">Session p√®re-fils</div>
                                </div>
                            </button>
                        </div>
                    </div>
                ) : (
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div className="bg-white p-6 rounded-lg shadow-md hover:shadow-lg transition-shadow cursor-pointer" onClick={() => onPageChange('sessions')}>
                            <div className="text-center">
                                <Play className="w-12 h-12 text-blue-600 mx-auto mb-4" />
                                <h3 className="text-lg font-semibold text-gray-900 mb-2">Sessions</h3>
                                <p className="text-gray-600 text-sm">Cr√©er ou reprendre une session de rem√©moration</p>
                            </div>
                        </div>
                        <div className="bg-white p-6 rounded-lg shadow-md hover:shadow-lg transition-shadow cursor-pointer" onClick={() => onPageChange('memories')}>
                            <div className="text-center">
                                <Cloud className="w-12 h-12 text-green-600 mx-auto mb-4" />
                                <h3 className="text-lg font-semibold text-gray-900 mb-2">M√©moires</h3>
                                <p className="text-gray-600 text-sm">Explorer le blog Mastodon et les photos</p>
                            </div>
                        </div>
                        <div className="bg-white p-6 rounded-lg shadow-md hover:shadow-lg transition-shadow cursor-pointer" onClick={() => onPageChange('settings')}>
                            <div className="text-center">
                                <Settings className="w-12 h-12 text-purple-600 mx-auto mb-4" />
                                <h3 className="text-lg font-semibold text-gray-900 mb-2">R√©glages</h3>
                                <p className="text-gray-600 text-sm">Configuration et pr√©f√©rences</p>
                            </div>
                        </div>
                    </div>
                )}
            </div>
        );
		const GamesPage = ({ currentUser, onPageChange, onGameSelect }) => (
    <div className="space-y-6 fade-in">
        <div className="flex justify-between items-center">
            <h2 className="text-2xl font-bold text-amber-900">Catalogue de jeux de rem√©moration</h2>
            <button
                onClick={() => {
                    const randomGame = GAMES[Math.floor(Math.random() * GAMES.length)];
                    onGameSelect(randomGame);
                }}
                className="flex items-center space-x-2 px-4 py-2 bg-purple-500 hover:bg-purple-600 text-white rounded-lg"
            >
                <Shuffle className="w-4 h-4" />
                <span>Jeu au hasard</span>
            </button>
        </div>

        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
            {GAMES.map(game => {
                const IconComponent = game.icon;
                return (
                    <button
                        key={game.id}
                        onClick={() => onGameSelect(game)}
                        className="p-6 border-2 border-gray-200 rounded-lg hover:border-amber-300 hover:bg-amber-50 transition-all text-left group"
                    >
                        <div className="flex items-start space-x-4">
                            <IconComponent className="w-8 h-8 text-amber-600 mt-1 flex-shrink-0" />
                            <div className="flex-1">
                                <div className="flex justify-between items-start mb-2">
                                    <h3 className="font-semibold text-lg text-amber-900 group-hover:text-amber-800">
                                        {game.title}
                                    </h3>
                                    <span className="text-xs bg-gray-100 px-2 py-1 rounded text-gray-600">
                                        {game.duration}
                                    </span>
                                </div>
                                <p className="text-gray-600 text-sm leading-relaxed mb-2">
                                    {game.description}
                                </p>
                                <div className="flex justify-between items-center">
                                    <div className="text-xs text-amber-600 font-medium">
                                        {game.type}
                                    </div>
                                    <div className="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded">
                                        ‚ñ∂Ô∏è Cr√©er session
                                    </div>
                                </div>
                            </div>
                        </div>
                    </button>
                );
            })}
        </div>

        <div className="bg-amber-50 border border-amber-200 rounded-lg p-4">
            <h3 className="font-semibold text-amber-900 mb-2">üí° Comment √ßa marche ?</h3>
            <p className="text-amber-700 text-sm">
                Choisissez un jeu pour cr√©er une nouvelle session de rem√©moration. 
                Vous pourrez ensuite √©changer vos souvenirs dans un format de chat convivial.
            </p>
        </div>
    </div>
);
		
        
// Page Session (MODIFI√âE)
const SessionsPage = ({ currentUser, onPageChange, onSessionSelect }) => {
    const { sessions, deleteSession, syncSessions } = useSessionState();
    const [isSyncing, setIsSyncing] = React.useState(true);
    const [syncComplete, setSyncComplete] = React.useState(false);

    React.useEffect(() => {
        const performInitialSync = async () => {
            try {
                setIsSyncing(true);
                await syncSessions();
                setSyncComplete(true);
            } catch (error) {
                console.error('Erreur synchronisation initiale:', error);
                setSyncComplete(true);
            } finally {
                setIsSyncing(false);
            }
        };
        performInitialSync();
    }, []);

    const formatDate = (dateString) => {
        return new Date(dateString).toLocaleDateString('fr-FR', { 
            day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit'
        });
    };
    
    const statusIcons = {
        active: { icon: Play, color: 'text-green-500', title: 'Active' },
        paused: { icon: Pause, color: 'text-orange-500', title: 'En pause' },
        pending: { icon: Clock, color: 'text-blue-500', title: 'En attente' },
        completed: { icon: FileText, color: 'text-gray-500', title: 'Termin√©e' }
    };

    return (
        <div className="space-y-4 fade-in">
            <div className="flex justify-between items-center">
                <button
                    onClick={() => onPageChange('games')}
                    className="w-full flex items-center justify-center space-x-2 px-4 py-3 bg-amber-500 hover:bg-amber-600 text-white rounded-lg font-semibold shadow"
                >
                    <Plus className="w-5 h-5" />
                    <span>Nouveau Jeu de M√©moire</span>
                </button>
            </div>

            {isSyncing && !syncComplete ? (
                // CODE CORRIG√â : Le JSX de chargement est de retour
                <div className="text-center py-12">
                    <div className="animate-spin w-12 h-12 border-4 border-amber-200 border-t-amber-600 rounded-full mx-auto mb-4"></div>
                    <h3 className="text-lg font-medium text-gray-900 mb-2">Synchronisation...</h3>
                    <p className="text-gray-600">Chargement depuis Google Drive...</p>
                </div>
            ) : sessions.length === 0 ? (
                // CODE CORRIG√â : Le JSX "aucune session" est de retour
                <div className="text-center py-12">
                    <BookOpen className="w-16 h-16 text-gray-300 mx-auto mb-4" />
                    <h3 className="text-lg font-medium text-gray-900 mb-2">Aucune session pour le moment</h3>
                    <p className="text-gray-600">Commencez par lancer un nouveau jeu de m√©moire !</p>
                </div>
            ) : (
                // Le code pour afficher la liste des sessions (qui √©tait correct)
                <div className="space-y-3">
                    {sessions.map((session) => {
                        const StatusIcon = statusIcons[session.status]?.icon || FileText;
                        const statusColor = statusIcons[session.status]?.color || 'text-gray-500';
                        const statusTitle = statusIcons[session.status]?.title || 'Archiv√©e';

                        return (
                            <div
                                key={session.id}
                                onClick={() => onSessionSelect(session)}
                                className="bg-white p-3 rounded-lg border border-gray-200 hover:border-amber-400 transition-colors cursor-pointer flex items-center space-x-3"
                            >
                                <div className="flex-1 min-w-0">
                                    <div className="flex justify-between items-start">
                                        <h3 className="font-bold text-gray-800 pr-2 truncate">{session.gameTitle}</h3>
                                        <span className="text-xs text-gray-400 whitespace-nowrap">{(session.notes || []).length} notes</span>
                                    </div>
                                    <div className="flex items-center space-x-2 mt-1">
                                        <span className="text-lg">{USERS[session.user]?.emoji}</span>
                                        <span className="text-xs text-gray-500">{formatDate(session.updatedAt)}</span>
                                    </div>
                                </div>
                                <div className="flex flex-col items-center space-y-2">
                                     <StatusIcon className={`w-6 h-6 ${statusColor}`} title={statusTitle} />
                                     <button
                                        onClick={(e) => {
                                            e.stopPropagation();
                                            if (confirm(`Supprimer la session "${session.gameTitle}" ?`)) {
                                                deleteSession(session.id);
                                            }
                                        }}
                                        className="p-1 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded-full"
                                    >
                                        <Trash2 className="w-4 h-4" />
                                    </button>
                                </div>
                            </div>
                        );
                    })}
                </div>
            )}
        </div>
    );
};

// Page Chat (MODIFI√âE)
// Page Chat (MODIFI√âE - √âdition du titre)
const ChatPage = ({ currentUser, currentSession, onUpdateSession, onBackToSessions }) => {
    const [newMessageContent, setNewMessageContent] = React.useState('');
    const [editingMessage, setEditingMessage] = React.useState(null);
    const [editContent, setEditContent] = React.useState('');
    const [editingTitle, setEditingTitle] = React.useState(false);
    const [titleContent, setTitleContent] = React.useState('');
    const messagesEndRef = React.useRef(null);
    const { renderGameIcon } = useSessionState();

    // Auto-scroll vers le bas des messages
    React.useEffect(() => {
        if (currentSession?.notes && messagesEndRef.current) {
            messagesEndRef.current.scrollIntoView({ behavior: 'smooth' });
        }
    }, [currentSession?.notes]);

    if (!currentSession) {
        return (
            <div className="text-center py-12">
                <Send className="w-16 h-16 text-gray-300 mx-auto mb-4" />
                <h3 className="text-lg font-medium text-gray-900 mb-2">Aucune session s√©lectionn√©e</h3>
                <button
                    onClick={onBackToSessions}
                    className="px-6 py-3 bg-amber-500 hover:bg-amber-600 text-white rounded-lg font-medium"
                >
                    Retour aux sessions
                </button>
            </div>
        );
    }

    const formatTime = (dateString) => {
        return new Date(dateString).toLocaleTimeString('fr-FR', { 
            hour: '2-digit',
            minute: '2-digit'
        });
    };

    const formatDate = (dateString) => {
        return new Date(dateString).toLocaleDateString('fr-FR', { 
            day: 'numeric', 
            month: 'short',
            hour: '2-digit',
            minute: '2-digit'
        });
    };

    // NOUVEAU : Fonctions pour √©diter le titre
    const startEditTitle = () => {
        setEditingTitle(true);
        setTitleContent(currentSession.gameTitle || '');
    };

    const saveTitle = async () => {
        if (!titleContent.trim()) return;
        
        const updatedSession = {
            ...currentSession,
            gameTitle: titleContent.trim()
        };
        
        await onUpdateSession(updatedSession);
        setEditingTitle(false);
    };

    const cancelEditTitle = () => {
        setEditingTitle(false);
        setTitleContent('');
    };

    const sendMessage = async () => {
        if (!newMessageContent.trim()) return;

        const newMessage = {
            id: Date.now(),
            content: newMessageContent.trim(),
            author: currentUser,
            timestamp: new Date().toISOString()
        };

        const updatedSession = {
            ...currentSession,
            notes: [...(currentSession.notes || []), newMessage]
        };

        await onUpdateSession(updatedSession);
        setNewMessageContent('');
    };

    const startEditMessage = (message) => {
        setEditingMessage(message.id);
        setEditContent(message.content);
    };

    const saveEditMessage = async (messageId) => {
        if (!editContent.trim()) return;

        const updatedSession = {
            ...currentSession,
            notes: (currentSession.notes || []).map(note => 
                note.id === messageId 
                    ? { ...note, content: editContent.trim(), edited: true }
                    : note
            )
        };

        await onUpdateSession(updatedSession);
        setEditingMessage(null);
        setEditContent('');
    };

    const cancelEdit = () => {
        setEditingMessage(null);
        setEditContent('');
    };

    const deleteMessage = async (messageId) => {
        if (!confirm('Supprimer ce message ?')) return;

        const updatedSession = {
            ...currentSession,
            notes: (currentSession.notes || []).filter(note => note.id !== messageId)
        };

        await onUpdateSession(updatedSession);
    };

    const inviteOtherUser = async () => {
        const otherUser = currentUser === 'tom' ? 'lambert' : 'tom';
        alert(`Invitation envoy√©e √† ${USERS[otherUser]?.name} !`);
        
        const updatedSession = {
            ...currentSession,
            status: 'pending',
            lastPingBy: currentUser
        };
        await onUpdateSession(updatedSession);
    };

    const pauseSession = async () => {
        const updatedSession = {
            ...currentSession,
            status: 'paused'
        };
        await onUpdateSession(updatedSession);
    };

    const closeSession = async () => {
        const updatedSession = {
            ...currentSession,
            status: 'completed'
        };
        
        await onUpdateSession(updatedSession);
        onBackToSessions();
    };

    return (
        <div className="flex flex-col h-screen max-h-[85vh] fade-in">
            {/* Session Header - MODIFI√â */}
            <div className="bg-amber-50 border border-amber-200 rounded-lg p-3 mb-3 flex-shrink-0">
                <div className="flex items-center justify-between">
                    <div className="flex items-center space-x-3">
                        <button
                            onClick={onBackToSessions}
                            className="p-1 hover:bg-amber-200 rounded"
                            title="Retour aux sessions"
                        >
                            <ArrowLeft className="w-5 h-5 text-amber-700" />
                        </button>
                        {renderGameIcon(currentSession.gameId, "w-6 h-6 text-amber-600")}
                        <div>
                            {/* TITRE √âDITABLE */}
                            {editingTitle ? (
                                <div className="flex items-center space-x-2">
                                    <input
                                        type="text"
                                        value={titleContent}
                                        onChange={(e) => setTitleContent(e.target.value)}
                                        onKeyDown={(e) => {
                                            if (e.key === 'Enter') saveTitle();
                                            if (e.key === 'Escape') cancelEditTitle();
                                        }}
                                        className="font-bold text-amber-900 text-base bg-white border border-amber-300 rounded px-2 py-1 min-w-0 flex-1"
                                        autoFocus
                                        onBlur={saveTitle}
                                    />
                                    <button
                                        onClick={saveTitle}
                                        className="p-1 bg-green-100 hover:bg-green-200 text-green-700 rounded"
                                        title="Sauvegarder"
                                    >
                                        <Edit className="w-4 h-4" />
                                    </button>
                                    <button
                                        onClick={cancelEditTitle}
                                        className="p-1 bg-red-100 hover:bg-red-200 text-red-700 rounded"
                                        title="Annuler"
                                    >
                                        √ó
                                    </button>
                                </div>
                            ) : (
                                <button
                                    onClick={startEditTitle}
                                    className="font-bold text-amber-900 text-base hover:bg-amber-100 px-2 py-1 rounded transition-colors flex items-center space-x-2 group"
                                    title="Cliquer pour renommer"
                                >
                                    <span>{currentSession.gameTitle || 'Session sans titre'}</span>
                                    <Edit className="w-4 h-4 opacity-0 group-hover:opacity-50 transition-opacity" />
                                </button>
                            )}
                            
                            {currentSession.postChapo && (
                                <p className="text-sm text-amber-700 mt-1 italic">
                                    "{currentSession.postChapo}"
                                </p>
                            )}
                            <div className="text-xs text-amber-600">
                                {formatDate(currentSession.createdAt)} ‚Ä¢ {(currentSession.notes || []).length} message(s)
                            </div>
                        </div>
                    </div>
                    
                    {/* Menu session - Inchang√© */}
                    <div className="flex space-x-1">
                        {currentUser !== 'duo' && (
                            <button
                                onClick={inviteOtherUser}
                                className="p-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg"
                                title="Inviter"
                            >
                                <Send className="w-4 h-4" />
                            </button>
                        )}
                        <button
                            onClick={pauseSession}
                            className="p-2 bg-orange-500 hover:bg-orange-600 text-white rounded-lg"
                            title="Pause"
                        >
                            <Pause className="w-4 h-4" />
                        </button>
                        <button
                            onClick={closeSession}
                            className="p-2 bg-gray-500 hover:bg-gray-600 text-white rounded-lg"
                            title="Terminer"
                        >
                            <Play className="w-4 h-4" />
                        </button>
                    </div>
                </div>
            </div>

            {/* Messages Container - Inchang√© */}
            <div className="flex-1 bg-gray-50 rounded-lg border overflow-y-auto p-4 space-y-3">
                {(!currentSession.notes || currentSession.notes.length === 0) ? (
                    <div className="text-center py-12 text-gray-500">
                        <BookOpen className="w-12 h-12 mx-auto mb-3 opacity-30" />
                        <p className="text-lg font-medium mb-2">Aucun message</p>
                        <p className="text-sm">Commencez la conversation en √©crivant vos souvenirs !</p>
                    </div>
                ) : (
                    <>
                        {/* Participants en haut une seule fois */}
                        <div className="text-center py-2 border-b border-gray-200 mb-4">
                            <div className="text-sm text-gray-600">
                                Conversation entre <span className="font-medium text-blue-700">{USERS.tom?.name}</span> et <span className="font-medium text-green-700">{USERS.lambert?.name}</span>
                            </div>
                        </div>

                        {(currentSession.notes || []).map((message) => {
                            const isOwnMessage = message.author === currentUser;
                            const isEditing = editingMessage === message.id;
                            
                            const getBubbleStyle = (author) => {
                                if (author === 'tom') return 'bg-blue-500 text-white';
                                if (author === 'lambert') return 'bg-green-500 text-white'; 
                                return 'bg-amber-500 text-white';
                            };

                            return (
                                <div key={message.id} className={`flex ${isOwnMessage ? 'justify-end' : 'justify-start'}`}>
                                    <div className={`max-w-[75%] ${isOwnMessage ? 'order-2' : 'order-1'}`}>
                                        <div className={`rounded-2xl px-4 py-3 ${getBubbleStyle(message.author)} ${isOwnMessage ? 'rounded-br-md' : 'rounded-bl-md'} relative group`}>
                                            {isEditing ? (
                                                <div className="space-y-2">
                                                    <textarea
                                                        value={editContent}
                                                        onChange={(e) => setEditContent(e.target.value)}
                                                        className="w-full bg-white text-gray-800 rounded p-2 text-sm resize-none"
                                                        rows="3"
                                                        autoFocus
                                                    />
                                                    <div className="flex space-x-2">
                                                        <button
                                                            onClick={() => saveEditMessage(message.id)}
                                                            className="px-3 py-1 bg-white text-green-600 rounded text-xs font-medium"
                                                        >
                                                            Sauver
                                                        </button>
                                                        <button
                                                            onClick={cancelEdit}
                                                            className="px-3 py-1 bg-white text-gray-600 rounded text-xs font-medium"
                                                        >
                                                            Annuler
                                                        </button>
                                                    </div>
                                                </div>
                                            ) : (
                                                <>
                                                    <p className="text-sm leading-relaxed whitespace-pre-wrap">
                                                        {message.content}
                                                    </p>
                                                    {message.edited && (
                                                        <span className="text-xs opacity-70 italic">modifi√©</span>
                                                    )}
                                                    
                                                    {isOwnMessage && (
                                                        <div className="absolute top-1 right-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                                            <button
                                                                onClick={() => startEditMessage(message)}
                                                                className="p-1 bg-white bg-opacity-20 hover:bg-opacity-40 rounded text-xs"
                                                                title="Modifier"
                                                            >
                                                                <Edit className="w-3 h-3" />
                                                            </button>
                                                            <button
                                                                onClick={() => deleteMessage(message.id)}
                                                                className="p-1 bg-white bg-opacity-20 hover:bg-opacity-40 rounded text-xs ml-1"
                                                                title="Supprimer"
                                                            >
                                                                <Trash2 className="w-3 h-3" />
                                                            </button>
                                                        </div>
                                                    )}
                                                </>
                                            )}
                                        </div>
                                    </div>
                                </div>
                            );
                        })}
                    </>
                )}
                <div ref={messagesEndRef} />
            </div>

            {/* Message Input - Inchang√© */}
            <div className="mt-4 flex-shrink-0">
                <div className="bg-white border-2 border-gray-200 focus-within:border-amber-500 rounded-xl p-2 transition-colors">
                    <div className="flex items-start space-x-2">
                        <textarea
                            value={newMessageContent}
                            onChange={(e) => setNewMessageContent(e.target.value)}
                            placeholder="√âcrivez vos souvenirs..."
                            className="flex-1 resize-none border-none focus:outline-none bg-transparent text-gray-800 p-2"
                            rows="3"
                        />
                        <button
                            onClick={sendMessage}
                            disabled={!newMessageContent.trim()}
                            className="w-12 h-12 self-end bg-blue-500 hover:bg-blue-600 disabled:bg-gray-300 text-white rounded-lg disabled:cursor-not-allowed flex items-center justify-center flex-shrink-0"
                            title="Envoyer"
                        >
                            <Send className="w-6 h-6" />
                        </button>
                    </div>
                </div>
            </div>
        </div>
    );
};

		
// Page Memoire (MODIFI√âE)
const MemoriesPage = ({ currentUser, onCreateSession }) => {
    const [currentPost, setCurrentPost] = React.useState(null);
    const [searchQuery, setSearchQuery] = React.useState('');
    const [searchResults, setSearchResults] = React.useState([]);
    const [dayNumber, setDayNumber] = React.useState(1);
    const [viewMode, setViewMode] = React.useState('blog');
    
    const isInitialLoad = React.useRef(true);

    const isImported = MastodonData.isImported();
    const stats = MastodonData.getStats();

    React.useEffect(() => {
        if (isImported && isInitialLoad.current) {
            const randomPost = MastodonData.getRandomPost();
            if (randomPost) {
                setCurrentPost(randomPost);
                setDayNumber(randomPost.dayNumber);
            }
            isInitialLoad.current = false;
        }
    }, [isImported]);

    React.useEffect(() => {
        if (isImported && !isInitialLoad.current) { // Ne pas re-chercher au premier chargement
            const post = MastodonData.getPostByDay(dayNumber);
            setCurrentPost(post);
        }
    }, [dayNumber, isImported]);

    const handleSearch = () => {
        if (searchQuery.trim()) {
            const results = MastodonData.searchPosts(searchQuery);
            setSearchResults(results);
            setViewMode('search');
        } else {
            setSearchResults([]);
            setViewMode('blog');
        }
    };
    
    const showRandomPost = () => {
        const randomPost = MastodonData.getRandomPost();
        if (randomPost) {
            setCurrentPost(randomPost);
            setDayNumber(randomPost.dayNumber);
            setViewMode('blog');
        }
    };

    const goToPreviousDay = () => {
        if (dayNumber > 1) {
            setDayNumber(dayNumber - 1);
            setViewMode('blog');
        }
    };

    const goToNextDay = () => {
        if (stats?.dayRange && dayNumber < stats.dayRange.max) {
            setDayNumber(dayNumber + 1);
            setViewMode('blog');
        }
    };

    const createSessionFromPost = (post) => {
        const game = {
            id: 7,
            title: `Jour ${post.dayNumber} - Souvenir`,
            description: `Discussion autour du post du jour ${post.dayNumber}`,
            duration: "libre",
            type: "m√©moire",
            icon: BookOpen
        };
        const postPreview = post.content.length > 200 ? post.content.slice(0, 200) + '...' : post.content;
        window.pendingGameSession = { game, user: currentUser, postChapo: postPreview };
        if (onCreateSession) {
            onCreateSession('chat'); // Navigue directement au chat apr√®s la cr√©ation
        }
    };

    if (!isImported) {
        return (
            <div className="space-y-6 fade-in">
                <div className="bg-blue-50 border border-blue-200 rounded-lg p-8 text-center">
                    <FileText className="w-16 h-16 text-blue-500 mx-auto mb-4" />
                    <h3 className="text-xl font-semibold text-blue-900 mb-4">Blog Mastodon non import√©</h3>
                    <p className="text-blue-700 mb-6">Importez votre fichier outbox.json pour explorer vos 275 posts de voyage.</p>
                    <p className="text-sm text-blue-600 mb-6">Rendez-vous dans <strong>R√©glages</strong> ‚Üí <strong>Importer blog Mastodon</strong></p>
                </div>
            </div>
        );
    }

    return (
        <div className="space-y-6 fade-in">
            {/* 1. Navigation et Hasard */}
            <div className="bg-white p-4 rounded-lg border border-gray-200 text-center">
                <div className="flex items-center justify-center space-x-4">
                    <button onClick={goToPreviousDay} disabled={dayNumber <= 1} className="p-2 bg-gray-100 hover:bg-gray-200 disabled:opacity-50 rounded-lg"><ChevronLeft className="w-5 h-5" /></button>
                    <div className="flex items-baseline space-x-2">
                        <label className="font-medium text-gray-700">Jour</label>
                        <input type="number" min="1" max={stats?.dayRange?.max} value={dayNumber} onChange={(e) => setDayNumber(parseInt(e.target.value) || 1)} className="w-20 px-2 py-1 border border-gray-300 rounded text-center font-bold text-lg"/>
                        <span className="text-gray-500">/ {stats?.dayRange?.max}</span>
                    </div>
                    <button onClick={goToNextDay} disabled={!stats?.dayRange || dayNumber >= stats.dayRange.max} className="p-2 bg-gray-100 hover:bg-gray-200 disabled:opacity-50 rounded-lg"><ChevronRight className="w-5 h-5" /></button>
                    <button onClick={showRandomPost} className="p-2 bg-purple-100 hover:bg-purple-200 text-purple-700 rounded-lg" title="Post au hasard"><Shuffle className="w-5 h-5" /></button>
                </div>
            </div>

            {/* 2. Recherche */}
            <div className="bg-white p-4 rounded-lg border border-gray-200">
                <div className="flex space-x-2">
                    <input type="text" value={searchQuery} onChange={(e) => setSearchQuery(e.target.value)} onKeyDown={(e) => e.key === 'Enter' && handleSearch()} placeholder="Rechercher un souvenir..." className="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-1 focus:ring-amber-500" />
                    <button onClick={handleSearch} className="px-4 py-2 bg-amber-500 hover:bg-amber-600 text-white rounded-lg"><Search className="w-5 h-5" /></button>
                </div>
            </div>

            {/* 3. Contenu (Post ou r√©sultats de recherche) */}
            {viewMode === 'search' && searchResults.length > 0 ? (
                // CODE CORRIG√â : Le JSX pour les r√©sultats de recherche est de retour
                <div className="space-y-4">
                    <h3 className="text-lg font-semibold text-gray-900">{searchResults.length} r√©sultat(s) pour "{searchQuery}"</h3>
                    {searchResults.map((post) => (
                        <div key={post.id} className="bg-white p-4 rounded-lg border border-gray-200">
                            <div className="flex justify-between items-start mb-3">
                                <h4 className="font-medium text-amber-900">Jour {post.dayNumber}</h4>
                                <div className="flex space-x-2">
                                    <button onClick={() => { setDayNumber(post.dayNumber); setViewMode('blog'); }} className="px-3 py-1 bg-blue-100 hover:bg-blue-200 text-blue-800 rounded text-sm">Voir</button>
                                    <button onClick={() => createSessionFromPost(post)} className="px-3 py-1 bg-green-100 hover:bg-green-200 text-green-800 rounded text-sm flex items-center space-x-1"><Plus className="w-3 h-3" /><span>Session</span></button>
                                </div>
                            </div>
                            <p className="text-gray-700 text-sm leading-relaxed">{post.content.slice(0, 300)}{post.content.length > 300 && '...'}</p>
                        </div>
                    ))}
                </div>
            ) : viewMode === 'search' && searchResults.length === 0 && searchQuery ? (
                // CODE CORRIG√â : Le JSX pour "aucun r√©sultat" est de retour
                <div className="bg-gray-50 p-8 rounded-lg text-center">
                    <Search className="w-12 h-12 text-gray-300 mx-auto mb-3" />
                    <h3 className="text-lg font-medium text-gray-600 mb-2">Aucun r√©sultat</h3>
                    <p className="text-gray-500">Essayez d'autres mots-cl√©s.</p>
                </div>
            ) : currentPost ? (
                <div className="bg-white p-6 rounded-lg border border-gray-200">
                    <div className="flex justify-between items-start mb-4">
                        <h3 className="text-2xl font-bold text-amber-900">Jour {currentPost.dayNumber}</h3>
                        <button onClick={() => createSessionFromPost(currentPost)} className="flex items-center space-x-2 px-3 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg text-sm font-semibold">
                            <Plus className="w-4 h-4" />
                            <span>Session</span>
                        </button>
                    </div>
                    <div className="prose max-w-none prose-p:text-gray-800 prose-p:leading-relaxed prose-p:whitespace-pre-line">
                        <p>{currentPost.content}</p>
                    </div>
                    <div className="mt-4 pt-4 border-t border-gray-200 flex justify-between items-center text-sm text-gray-500">
                        <span>{new Date(currentPost.published).toLocaleDateString('fr-FR', { day: 'numeric', month: 'long', year: 'numeric' })}</span>
                        {currentPost.attachments && currentPost.attachments.length > 0 && (
                            <span className="flex items-center space-x-1 font-medium">
                                <Camera className="w-4 h-4"/>
                                <span>{currentPost.attachments.length}</span>
                            </span>
                        )}
                    </div>
                </div>
            ) : (
                <div className="bg-gray-50 p-8 rounded-lg text-center">
                    <BookOpen className="w-12 h-12 text-gray-300 mx-auto mb-3" />
                    <h3 className="text-lg font-medium text-gray-600 mb-2">Aucun post ce jour</h3>
                    <p className="text-gray-500">Essayez un autre jour ou utilisez la recherche.</p>
                </div>
            )}
        </div>
    );
};
// ====Pages Config r√©glages Settings  =====
        const SettingsPage = ({ onReset, googleAuth, onGoogleDisconnect }) => {
            const [importStatus, setImportStatus] = React.useState('');
            const [isImporting, setIsImporting] = React.useState(false);
            const fileInputRef = React.useRef(null);

			// Ajouter les hooks Google Auth
    		const { isConnected, isLoading, userInfo, signIn, signOut } = useGoogleAuth();

            const stats = MastodonData.getStats();
            const isImported = MastodonData.isImported();

            const handleFileImport = async (event) => {
                const file = event.target.files[0];
                if (!file) return;

                setIsImporting(true);
                setImportStatus('Lecture du fichier...');

                try {
                    const text = await file.text();
                    setImportStatus('Analyse des donn√©es...');
                    
                    const posts = MastodonData.parseOutbox(text);
                    MastodonData.savePosts(posts);
                    
                    setImportStatus(`Succ√®s ! ${posts.length} posts import√©s`);
                    setTimeout(() => setImportStatus(''), 3000);
                } catch (error) {
                    console.error('Erreur import:', error);
                    setImportStatus(`Erreur: ${error.message}`);
                    setTimeout(() => setImportStatus(''), 5000);
                } finally {
                    setIsImporting(false);
                    // R√©initialiser l'input file
                    if (fileInputRef.current) {
                        fileInputRef.current.value = '';
                    }
                }
            };

            const clearMastodonData = () => {
                if (confirm('Supprimer toutes les donn√©es Mastodon import√©es ?')) {
                    Storage.remove('mastodon_posts');
                    Storage.remove('mastodon_imported_at');
                    setImportStatus('Donn√©es Mastodon supprim√©es');
                    setTimeout(() => setImportStatus(''), 3000);
                }
            };

            return (
                <div className="space-y-6 fade-in">
                    
					{/* Bandeau Google Drive d√©plac√© ici */}
            		<GoogleConnection 
                		isConnected={isConnected}
                		isLoading={isLoading}
                		userInfo={userInfo}
                		onSignIn={signIn}
                		onSignOut={onGoogleDisconnect || signOut}
            		/>
					
                    {/* Import Mastodon */}
                    <div className="bg-white p-6 rounded-lg shadow-md space-y-4">
                        <h3 className="text-lg font-semibold text-gray-900">Blog Mastodon</h3>
                        
                        {isImported ? (
                            <div className="bg-green-50 border border-green-200 p-4 rounded-lg">
                                <div className="flex items-center justify-between">
                                    <div>
                                        <div className="font-medium text-green-900">Blog import√© avec succ√®s</div>
                                        <div className="text-sm text-green-700">
                                            {stats.totalPosts} posts ‚Ä¢ Jours {stats.dayRange?.min}-{stats.dayRange?.max}
                                        </div>
                                        <div className="text-xs text-green-600 mt-1">
                                            Import√© le {new Date(stats.importedAt).toLocaleDateString('fr-FR')}
                                        </div>
                                    </div>
                                    <button
                                        onClick={clearMastodonData}
                                        className="px-3 py-1 bg-red-100 hover:bg-red-200 text-red-700 rounded text-sm"
                                    >
                                        Supprimer
                                    </button>
                                </div>
                            </div>
                        ) : (
                            <div className="space-y-4">
                                <p className="text-gray-600">
                                    Importez votre fichier outbox.json pour explorer vos posts Mastodon
                                </p>
                                
                                <div className="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center">
                                    <input
                                        ref={fileInputRef}
                                        type="file"
                                        accept=".json"
                                        onChange={handleFileImport}
                                        className="hidden"
                                        id="mastodon-file"
                                        disabled={isImporting}
                                    />
                                    <label
                                        htmlFor="mastodon-file"
                                        className={`cursor-pointer flex flex-col items-center ${isImporting ? 'opacity-50 cursor-not-allowed' : ''}`}
                                    >
                                        <Upload className="w-12 h-12 text-gray-400 mb-3" />
                                        <div className="text-lg font-medium text-gray-700">
                                            {isImporting ? 'Import en cours...' : 'S√©lectionner outbox.json'}
                                        </div>
                                        <div className="text-sm text-gray-500 mt-1">
                                            Cliquez pour parcourir vos fichiers
                                        </div>
                                    </label>
                                </div>

                                {importStatus && (
                                    <div className={`p-3 rounded-lg text-sm ${
                                        importStatus.includes('Erreur') 
                                            ? 'bg-red-100 text-red-700 border border-red-200'
                                            : importStatus.includes('Succ√®s')
                                            ? 'bg-green-100 text-green-700 border border-green-200'
                                            : 'bg-blue-100 text-blue-700 border border-blue-200'
                                    }`}>
                                        {importStatus}
                                    </div>
                                )}

                                <div className="bg-amber-50 border border-amber-200 p-4 rounded-lg">
                                    <div className="text-sm text-amber-800">
                                        <div className="font-medium mb-2">Comment obtenir outbox.json :</div>
                                        <div className="space-y-1">
                                            <div>1. Connectez-vous √† votre instance Mastodon</div>
                                            <div>2. Allez dans Pr√©f√©rences ‚Üí Import et export</div>
                                            <div>3. T√©l√©chargez "Archive de donn√©es"</div>
                                            <div>4. Extrayez et s√©lectionnez le fichier outbox.json</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>

                    {/* Donn√©es g√©n√©rales */}
                    <div className="bg-white p-6 rounded-lg shadow-md space-y-4">
                        <h3 className="text-lg font-semibold text-gray-900">Donn√©es</h3>
                        <div>
                            <button 
                                onClick={() => {
                                    if (confirm('Effacer toutes les donn√©es sauvegard√©es (sessions, utilisateur, etc.) ?')) onReset();
                                }}
                                className="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg text-sm font-medium"
                            >
                                Reset complet
                            </button>
                        </div>
                        <div className="pt-4 border-t border-gray-200">
                            <h4 className="font-medium text-gray-700 mb-2">Stockage actuel</h4>
                            <div className="text-sm text-gray-600 space-y-1">
                                <div>Utilisateur: {Storage.get('currentUser') || 'Non d√©fini'}</div>
                                <div>Sessions: {Storage.get('sessions', []).length} session(s) sauvegard√©e(s)</div>
                                <div>Posts Mastodon: {MastodonData.getPosts().length} post(s) import√©(s)</div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };
		
// ===== MAIN APP =====
// ===== MAIN APP (VERSION FINALE CORRIG√âE) =====
        const MemoireMekong = () => {
            const {
                currentPage, setCurrentPage,
                currentUser, setCurrentUser,
                resetApp
            } = useAppState();

            const { isConnected, isLoading, userInfo, signIn, signOut } = useGoogleAuth();
            const { sessions, setSessions, updateSession, createSession, syncSessions } = useSessionState();

            const [currentChatSession, setCurrentChatSession] = React.useState(null);
            const [toast, setToast] = React.useState({ message: '', type: '' });

            // Synchronisation automatique au chargement et lors de la connexion
            React.useEffect(() => {
                let isMounted = true; // √âviter les appels apr√®s unmount
                
                const autoSync = async () => {
                    if (isConnected && !isLoading) {
                        try {
                            console.log('üîÑ Synchronisation automatique...');
                            if (isMounted) {
                                await syncSessions();
                                console.log('‚úÖ Synchronisation termin√©e');
                            }
                        } catch (error) {
                            console.warn('‚ö†Ô∏è Sync auto √©chou√©e:', error.message);
                            if (isMounted) {
                                setToast({ message: "Synchronisation automatique √©chou√©e", type: 'error' });
                            }
                        }
                    }
                };

                // D√©lai pour √©viter les appels trop fr√©quents
                const timeoutId = setTimeout(autoSync, 500);
                
                return () => {
                    isMounted = false;
                    clearTimeout(timeoutId);
                };
            }, [isConnected, isLoading]); // Retirer syncSessions des d√©pendances

            // G√©rer la cr√©ation automatique de session depuis les jeux/m√©moires
            React.useEffect(() => {
                const handlePendingSession = async () => {
                    if (window.pendingGameSession && window.pendingGameSession.user === currentUser && currentPage === 'chat') {
                        const newSession = await createSession(window.pendingGameSession.game, window.pendingGameSession.user);
                        if (newSession) {
                            setCurrentChatSession(newSession);
                        }
                    }
                };
                
                if (currentPage === 'chat') {
                    handlePendingSession();
                }
            }, [currentUser, currentPage, createSession]);

            const handleSessionSelect = (session) => {
                setCurrentChatSession(session);
                setCurrentPage('chat');
            };

            const handleBackToSessions = () => {
                setCurrentChatSession(null);
                setCurrentPage('sessions');
            };

            const handleUpdateSession = async (updatedSession) => {
                try {
                    await updateSession(updatedSession);
                    setCurrentChatSession(updatedSession);
                } catch (error) {
                    setToast({ message: error.message, type: 'error' });
                    // Met √† jour l'interface avec les donn√©es locales m√™me si le cloud a √©chou√©
                    const localSessions = Storage.get('sessions', []);
                    setSessions(localSessions); 
                    setCurrentChatSession(updatedSession);
                }
            };

            return (
    <div className="min-h-screen bg-gradient-to-br from-amber-50 to-orange-100">
        
        {/* Barre du haut, toujours visible */}
        <TopBar
            currentPage={currentPage}
            currentUser={currentUser}
            onUserChange={setCurrentUser}
            onPageChange={setCurrentPage}
            googleStatus={{ isConnected, isLoading, userInfo }}
            onGoogleAction={async () => {
                if (!isConnected && !isLoading) {
                    try {
                        const success = await signIn();
                        if (success) {
                            setToast({ message: "Connexion Google Drive r√©ussie !", type: 'success' });
                        }
                    } catch (error) {
                        setToast({ message: "Erreur de connexion Google Drive", type: 'error' });
                    }
                } else {
                    setCurrentPage('settings');
                }
            }}
        />

        {/* Contenu principal de la page avec marges pour ne pas √™tre cach√© par les barres */}
        <main className="p-4 pb-24">
            <div className="max-w-6xl mx-auto">
                <div className="bg-white/80 backdrop-blur rounded-xl shadow-lg p-6">
                    {currentPage === 'home' && (
                        <HomePage 
                            currentUser={currentUser}
                            onUserChange={setCurrentUser}
                            onPageChange={setCurrentPage}
                        />
                    )}
                    {currentPage === 'games' && (
                        <GamesPage 
                            currentUser={currentUser}
                            onPageChange={setCurrentPage}
                            onGameSelect={(game) => {
                                window.pendingGameSession = { game, user: currentUser };
                                setCurrentPage('chat');
                            }}
                        />
                    )}
                    {currentPage === 'sessions' && (
                        <SessionsPage 
                            currentUser={currentUser} 
                            onPageChange={setCurrentPage}
                            onSessionSelect={handleSessionSelect}
                        />
                    )}
                    {currentPage === 'chat' && (
                        <ChatPage 
                            currentUser={currentUser}
                            currentSession={currentChatSession}
                            onUpdateSession={handleUpdateSession}
                            onBackToSessions={handleBackToSessions}
                        />
                    )}
                    {currentPage === 'memories' && (
                        <MemoriesPage 
                            currentUser={currentUser}
                            onCreateSession={(page) => {
                                setCurrentPage(page);
                            }}
                        />
                    )}
                    {currentPage === 'settings' && (
                        <SettingsPage 
                            onReset={resetApp}
                            googleAuth={{
                                isConnected: isConnected,
                                isLoading: isLoading,
                                userInfo: userInfo,
                                signIn: signIn,
                                signOut: signOut
                            }}
                            onGoogleDisconnect={async () => {
                                await signOut();
                                setToast({ message: "D√©connexion r√©ussie", type: 'success' });
                            }}
                        />
                    )}
                    {currentPage === 'users' && (
                        <UsersPage 
                            currentUser={currentUser}
                            onUserChange={setCurrentUser}
                            onPageChange={setCurrentPage}
                        />
                    )}
                </div>
            </div>
        </main>
        
        {/* Barre de navigation du bas, toujours visible */}
        <BottomNavBar
            currentPage={currentPage}
            onPageChange={setCurrentPage}
            currentUser={currentUser}
        />

        {/* Le composant Toast pour les notifications */}
        <Toast 
            message={toast.message} 
            type={toast.type} 
            onDismiss={() => setToast({ message: '', type: '' })} 
        />
    </div>
);
                
        };
        // ===== RENDER =====
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(React.createElement(MemoireMekong));
    </script>
</body>
</html>
