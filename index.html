<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üêò M√©moire du M√©kong V0.2.9</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .lucide { width: 1em; height: 1em; fill: none; stroke: currentColor; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // ===== ICONS LUCIDE =====
        const Home = ({ className = "" }) => <svg className={`lucide ${className}`} viewBox="0 0 24 24"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9,22 9,12 15,12 15,22"/></svg>;
        const Users = ({ className = "" }) => <svg className={`lucide ${className}`} viewBox="0 0 24 24"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="m22 21-2-2"/></svg>;
        const User = ({ className = "" }) => <svg className={`lucide ${className}`} viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>;
        const Play = ({ className = "" }) => <svg className={`lucide ${className}`} viewBox="0 0 24 24"><polygon points="5,3 19,12 5,21"/></svg>;
        const Camera = ({ className = "" }) => <svg className={`lucide ${className}`} viewBox="0 0 24 24"><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></svg>;
        const Cloud = ({ className = "" }) => <svg className={`lucide ${className}`} viewBox="0 0 24 24"><path d="M17.5 19H9a7 7 0 1 1 6.71-9h1.79a4.5 4.5 0 1 1 0 9Z"/></svg>;
        const Settings = ({ className = "" }) => <svg className={`lucide ${className}`} viewBox="0 0 24 24"><path d="M12.22 2h-.44a2 2 0 0 0-2 2.18l.2 1.81c-.26.06-.51.14-.76.23l-1.5-1.16a2 2 0 0 0-2.83.32l-.22.38a2 2 0 0 0 .32 2.83l1.16 1.5c-.09.25-.17.5-.23.76l-1.81.2a2 2 0 0 0-2.18 2v.44a2 2 0 0 0 2.18 2l1.81.2c.06.26.14.51.23.76l-1.16 1.5a2 2 0 0 0-.32 2.83l.38.22a2 2 0 0 0 2.83-.32l1.5-1.16c.25.09.5.17.76.23l.2 1.81a2 2 0 0 0 2 2.18h.44a2 2 0 0 0 2-2.18l.2-1.81c.26-.06.51-.14.76-.23l1.5 1.16a2 2 0 0 0 2.83-.32l.22-.38a2 2 0 0 0-.32-2.83l-1.16-1.5c.09-.25.17-.5.23-.76l1.81-.2a2 2 0 0 0 2.18-2v-.44a2 2 0 0 0-2.18-2l-1.81-.2c-.06-.26-.14-.51-.23-.76l1.16-1.5a2 2 0 0 0 .32-2.83l-.38-.22a2 2 0 0 0-2.83.32l-1.5 1.16c-.25-.09-.5-.17-.76-.23l-.2-1.81a2 2 0 0 0-2-2.18Z"/><circle cx="12" cy="12" r="3"/></svg>;
        const ChevronLeft = ({ className = "" }) => <svg className={`lucide ${className}`} viewBox="0 0 24 24"><path d="m15 18-6-6 6-6"/></svg>;
        const ChevronRight = ({ className = "" }) => <svg className={`lucide ${className}`} viewBox="0 0 24 24"><path d="m9 18 6-6-6-6"/></svg>;
        const Clock = ({ className = "" }) => <svg className={`lucide ${className}`} viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><polyline points="12,6 12,12 16,14"/></svg>;
        const Mic = ({ className = "" }) => <svg className={`lucide ${className}`} viewBox="0 0 24 24"><path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" x2="12" y1="19" y2="22"/><line x1="8" x2="16" y1="22" y2="22"/></svg>;
        const Zap = ({ className = "" }) => <svg className={`lucide ${className}`} viewBox="0 0 24 24"><polygon points="13,2 3,14 12,14 11,22 21,10 12,10"/></svg>;
        const MapPin = ({ className = "" }) => <svg className={`lucide ${className}`} viewBox="0 0 24 24"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg>;
        const BookOpen = ({ className = "" }) => <svg className={`lucide ${className}`} viewBox="0 0 24 24"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>;
        const Edit = ({ className = "" }) => <svg className={`lucide ${className}`} viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="m18.5 2.5 3 3L12 15l-4 1 1-4 9.5-9.5Z"/></svg>;
        const Plus = ({ className = "" }) => <svg className={`lucide ${className}`} viewBox="0 0 24 24"><path d="M5 12h14"/><path d="M12 5v14"/></svg>;
        const Shuffle = ({ className = "" }) => <svg className={`lucide ${className}`} viewBox="0 0 24 24"><polyline points="16,3 21,3 21,8"/><line x1="4" x2="21" y1="20" y2="3"/><polyline points="21,16 21,21 16,21"/><line x1="15" x2="21" y1="15" y2="21"/><line x1="4" x2="9" y1="4" y2="9"/></svg>;
        const Pause = ({ className = "" }) => <svg className={`lucide ${className}`} viewBox="0 0 24 24"><rect width="4" height="16" x="6" y="4"/><rect width="4" height="16" x="14" y="4"/></svg>;
        const ArrowLeft = ({ className = "" }) => <svg className={`lucide ${className}`} viewBox="0 0 24 24"><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>;
        const Send = ({ className = "" }) => <svg className={`lucide ${className}`} viewBox="0 0 24 24"><path d="m22 2-7 20-4-9-9-4Z"/><path d="M22 2 11 13"/></svg>;
        const Trash2 = ({ className = "" }) => <svg className={`lucide ${className}`} viewBox="0 0 24 24"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="m8 6V4c0-1 1-2 2-2h4c0-1-1-2-2-2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>;

        // ===== CORE STORAGE =====
        const Storage = {
            get: (key, defaultValue = null) => {
                try {
                    const item = localStorage.getItem(`mekong_${key}`);
                    return item ? JSON.parse(item) : defaultValue;
                } catch { return defaultValue; }
            },
            set: (key, value) => {
                try {
                    localStorage.setItem(`mekong_${key}`, JSON.stringify(value));
                    return true;
                } catch { return false; }
            },
            remove: (key) => localStorage.removeItem(`mekong_${key}`),
            clear: () => {
                Object.keys(localStorage).forEach(key => {
                    if (key.startsWith('mekong_')) localStorage.removeItem(key);
                });
            }
        };

        // ===== CORE STATES =====
        const useAppState = () => {
            const [currentPage, setCurrentPage] = React.useState('home');
            const [currentUser, setCurrentUser] = React.useState(Storage.get('currentUser', ''));
            
            // Sauvegarde automatique
            React.useEffect(() => {
                Storage.set('currentUser', currentUser);
            }, [currentUser]);

            const resetApp = () => {
                setCurrentPage('home');
                setCurrentUser('');
                Storage.clear();
            };

            return {
                currentPage, setCurrentPage,
                currentUser, setCurrentUser,
                resetApp
            };
        };

        // ===== USER CONFIG =====
        const USERS = {
            tom: { name: 'Tom l\'√©l√©phantau', color: 'blue', emoji: 'üêò' },
            lambert: { name: 'Lambert, le Vieil √©l√©phant', color: 'green', emoji: 'üêò' },
            duo: { name: 'Duo Mekong Tandem', color: 'amber', emoji: 'üêòüêò' }
        };

        const getUserStyle = (userKey) => {
            const user = USERS[userKey];
            if (!user) return { bg: 'bg-gray-100', border: 'border-gray-300', text: 'text-gray-800' };
            
            const styles = {
                blue: { bg: 'bg-blue-100 hover:bg-blue-200', border: 'border-blue-300', text: 'text-blue-800' },
                green: { bg: 'bg-green-100 hover:bg-green-200', border: 'border-green-300', text: 'text-green-800' },
                amber: { bg: 'bg-amber-100 hover:bg-amber-200', border: 'border-amber-300', text: 'text-amber-800' }
            };
            return styles[user.color] || styles.blue;
        };

        // ===== GAMES CATALOG =====
        const GAMES = [
            { 
                id: 1, 
                title: "Photo roulette", 
                duration: "15 min", 
                type: "pr√©sentiel",
                icon: Camera, 
                description: "S√©lectionnez une photo au hasard et racontez tout ce qui vous revient en m√©moire" 
            },
            { 
                id: 2, 
                title: "Timeline aveugle", 
                duration: "20 min", 
                type: "pr√©sentiel",
                icon: Clock, 
                description: "Reconstituez la chronologie d'une √©tape sans regarder les dates" 
            },
            { 
                id: 3, 
                title: "Interview journaliste", 
                duration: "25 min", 
                type: "pr√©sentiel",
                icon: Mic, 
                description: "L'un interviewe l'autre sur une √©tape pr√©cise du voyage" 
            },
            { 
                id: 4, 
                title: "Photo sans l√©gende", 
                duration: "async", 
                type: "distanciel",
                icon: Camera, 
                description: "Envoyez une photo, l'autre devine le contexte et ses souvenirs" 
            },
            { 
                id: 5, 
                title: "Mot d√©clencheur", 
                duration: "async", 
                type: "distanciel",
                icon: Zap, 
                description: "Un mot-cl√© pour d√©clencher un souvenir chez l'autre" 
            },
            { 
                id: 6, 
                title: "G√©olocalisation myst√®re", 
                duration: "async", 
                type: "distanciel",
                icon: MapPin, 
                description: "Partagez une position GPS, l'autre raconte ce lieu" 
            }
        ];

        // ===== SESSION STORAGE =====
        const SessionStorage = {
            getSessions: () => {
    			const sessions = Storage.get('sessions', []);
    			// Nettoyer les sessions corrompues
    			return sessions.filter(session => {
        			const isValid = session && 
                       			typeof session.id !== 'undefined' && 
                       			typeof session.gameId === 'number' && 
                       			session.gameId > 0 &&
                       			Array.isArray(session.notes);
        			if (!isValid) {
            			console.warn('Session corrompue supprim√©e:', session);
        			}
        			return isValid;
    			});
			},
            saveSession: (session) => {
                const sessions = SessionStorage.getSessions();
                const existingIndex = sessions.findIndex(s => s.id === session.id);
                if (existingIndex >= 0) {
                    sessions[existingIndex] = session;
                } else {
                    sessions.unshift(session);
                }
                Storage.set('sessions', sessions);
            },
            deleteSession: (sessionId) => {
                const sessions = SessionStorage.getSessions().filter(s => s.id !== sessionId);
                Storage.set('sessions', sessions);
            }
        };

        // ===== SESSION HELPERS =====
        const getGameIcon = (gameId) => {
            if (!gameId || typeof gameId !== 'number') {
                console.log('getGameIcon: gameId invalide', gameId);
                return BookOpen; // S√©curit√© si gameId undefined/invalide
            }
            const game = GAMES.find(g => g.id === gameId);
            if (!game) {
                console.log('getGameIcon: jeu non trouv√© pour gameId', gameId);
                return BookOpen;
            }
            return game.icon;
        };

        const renderGameIcon = (gameId, className = "w-6 h-6 text-amber-600") => {
    		try {
        		const game = GAMES.find(g => g.id === gameId);
        		if (!game || !game.icon) {
            		console.warn('renderGameIcon: Jeu non trouv√© pour gameId:', gameId);
            		return React.createElement(BookOpen, { className });
        		}
        
        		const IconComponent = game.icon;
        		if (typeof IconComponent !== 'function') {
            		console.warn('renderGameIcon: Icon n\'est pas une fonction:', IconComponent);
            		return React.createElement(BookOpen, { className });
        		}
        
        		return React.createElement(IconComponent, { className });
    		} catch (error) {
        		console.error('renderGameIcon: Erreur lors du rendu:', error);
        		return React.createElement(BookOpen, { className });
    		}
		};

        const getGameById = (gameId) => {
            return GAMES.find(g => g.id === gameId);
        };

        // ===== SESSION HOOKS =====
        const useSessionState = () => {
            const [currentSession, setCurrentSession] = React.useState(null);
            const [sessionView, setSessionView] = React.useState('list'); // 'list', 'catalog', 'active'
            const [sessions, setSessions] = React.useState([]);

            React.useEffect(() => {
                setSessions(SessionStorage.getSessions());
            }, []);

            const createSession = (game, user) => {
                console.log('createSession appel√©e avec:', { game, user });
                
                if (!game || !game.id) {
                    console.error('createSession: jeu invalide', game);
                    return;
                }
                
                const newSession = {
                    id: Date.now(),
                    gameId: Number(game.id), // S'assurer que c'est un nombre
                    gameTitle: game.title || 'Titre inconnu',
                    gameDescription: game.description || 'Description inconnue',
                    gameDuration: game.duration || 'Dur√©e inconnue',
                    user: user,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString(),
                    status: 'active',
                    notes: [], // S'assurer que notes est toujours un tableau
                    participants: [user]
                    // NE PAS sauvegarder gameIcon - on le r√©cup√®rera depuis GAMES
                };
                
                console.log('Nouvelle session cr√©√©e:', newSession);
                
                SessionStorage.saveSession(newSession);
                setSessions(SessionStorage.getSessions());
                setCurrentSession(newSession);
                setSessionView('active');
            };

            const updateSession = (updatedSession) => {
                // S'assurer que notes existe toujours
                const sessionToSave = {
                    ...updatedSession, 
                    notes: updatedSession.notes || [],
                    updatedAt: new Date().toISOString()
                };
                
                SessionStorage.saveSession(sessionToSave);
                setSessions(SessionStorage.getSessions());
                setCurrentSession(sessionToSave);
            };

            const deleteSession = (sessionId) => {
                SessionStorage.deleteSession(sessionId);
                setSessions(SessionStorage.getSessions());
                if (currentSession?.id === sessionId) {
                    setCurrentSession(null);
                    setSessionView('list');
                }
            };

            return {
                currentSession, setCurrentSession,
                sessionView, setSessionView,
                sessions,
                createSession,
                updateSession,
                deleteSession,
                getGameIcon, // Exposer la fonction helper
                renderGameIcon // Exposer la fonction de rendu s√©curis√©e
            };
        };

        // ===== NAVIGATION COMPONENT =====
        const Navigation = ({ currentPage, currentUser, onPageChange, onUserChange, onBack }) => (
    <div className="bg-white/90 backdrop-blur rounded-xl shadow-lg p-3 mb-4">
        <div className="flex justify-between items-center">
            {/* User Button + Back Navigation */}
            <div className="flex items-center space-x-2">
                {/* Back Button (si n√©cessaire) */}
                {onBack && (
                    <button
                        onClick={onBack}
                        className="p-2 text-gray-600 hover:text-gray-800 hover:bg-gray-100 rounded-lg"
                        title="Retour"
                    >
                        <ArrowLeft className="w-5 h-5" />
                    </button>
                )}
                
                {/* User Selection */}
                {currentUser ? (
                    <button
                        onClick={() => onUserChange('')}
                        className={`flex items-center space-x-2 px-3 py-2 rounded-lg border text-sm ${getUserStyle(currentUser).bg} ${getUserStyle(currentUser).border}`}
                        title="Changer d'utilisateur"
                    >
                        <span className="text-lg">{USERS[currentUser]?.emoji}</span>
                        <span className={`font-medium hidden sm:inline ${getUserStyle(currentUser).text}`}>
                            {USERS[currentUser]?.name.split(' ')[0]} {/* Juste le pr√©nom */}
                        </span>
                        <ChevronRight className="w-4 h-4 opacity-60" />
                    </button>
                ) : (
                    <button
                        onClick={() => onPageChange('home')}
                        className="flex items-center space-x-2 px-3 py-2 rounded-lg border border-gray-300 hover:bg-gray-100 text-sm"
                    >
                        <User className="w-4 h-4 text-gray-500" />
                        <span className="font-medium text-gray-600 hidden sm:inline">Utilisateur</span>
                    </button>
                )}
            </div>

            {/* Page Navigation - Ic√¥nes empil√©es sur mobile */}
            <div className="flex items-center space-x-1">
                {['home', 'games', 'sessions', 'memories', 'settings'].map((page) => {
                    const icons = { home: Home, games: Play, sessions: BookOpen, memories: Cloud, settings: Settings };
                    const labels = { home: 'Accueil', games: 'Jeux', sessions: 'Sessions', memories: 'M√©moires', settings: 'R√©glages' };
                    const shortLabels = { home: 'Accueil', games: 'Jeux', sessions: 'Sessions', memories: 'Photos', settings: 'Config' };
                    const Icon = icons[page];
                    
                    return (
                        <button
                            key={page}
                            onClick={() => onPageChange(page)}
                            disabled={!currentUser && page !== 'home'}
                            className={`flex flex-col items-center px-2 py-2 rounded-lg transition-all text-xs ${
                                currentPage === page 
                                    ? 'bg-amber-200 text-amber-800' 
                                    : !currentUser && page !== 'home'
                                    ? 'text-gray-400 cursor-not-allowed'
                                    : 'hover:bg-gray-100 text-gray-600'
                            }`}
                        >
                            <Icon className="w-5 h-5 mb-1" />
                            <span className="font-medium hidden sm:inline">{shortLabels[page]}</span>
                            <span className="font-medium sm:hidden">{shortLabels[page].slice(0,4)}</span>
                        </button>
                    );
                })}
            </div>
        </div>
    </div>
);

        // ===== MAIN PAGES =====
        const HomePage = ({ currentUser, onUserChange, onPageChange }) => (
            <div className="space-y-6 fade-in">
                <div className="text-center">
                    <h2 className="text-2xl font-bold text-amber-900 mb-4">
                        Bienvenue dans vos m√©moires du M√©kong
                    </h2>
                    {currentUser && (
                        <p className="text-amber-700 mb-6">
                            Bonjour <strong>{USERS[currentUser]?.name}</strong> ! Que souhaitez-vous faire aujourd'hui ?
                        </p>
                    )}
                </div>

                {!currentUser ? (
                    <div className="max-w-md mx-auto space-y-4">
                        <h3 className="text-lg font-semibold text-amber-900 text-center">Qui √™tes-vous ?</h3>
                        <div className="space-y-3">
                            <button
                                onClick={() => onUserChange('tom')}
                                className={`flex items-center space-x-3 p-4 border-2 rounded-lg w-full text-left transition-all ${getUserStyle('tom').bg} hover:${getUserStyle('tom').border}`}
                            >
                                <span className="text-3xl">üêò</span>
                                <div>
                                    <div className={`font-medium text-lg ${getUserStyle('tom').text}`}>Tom l'√©l√©phantau</div>
                                    <div className="text-sm text-gray-600">Le jeune aventurier</div>
                                </div>
                            </button>
                            <button
                                onClick={() => onUserChange('lambert')}
                                className={`flex items-center space-x-3 p-4 border-2 rounded-lg w-full text-left transition-all ${getUserStyle('lambert').bg} hover:${getUserStyle('lambert').border}`}
                            >
                                <span className="text-3xl">üêò</span>
                                <div>
                                    <div className={`font-medium text-lg ${getUserStyle('lambert').text}`}>Lambert, le Vieil √©l√©phant</div>
                                    <div className="text-sm text-gray-600">Le sage guide</div>
                                </div>
                            </button>
                            <button
                                onClick={() => onUserChange('duo')}
                                className={`flex items-center space-x-3 p-4 border-2 rounded-lg w-full text-left transition-all ${getUserStyle('duo').bg} hover:${getUserStyle('duo').border}`}
                            >
                                <span className="text-3xl">üêòüêò</span>
                                <div>
                                    <div className={`font-medium text-lg ${getUserStyle('duo').text}`}>Duo Mekong Tandem</div>
                                    <div className="text-sm text-gray-600">Session p√®re-fils</div>
                                </div>
                            </button>
                        </div>
                    </div>
                ) : (
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div className="bg-white p-6 rounded-lg shadow-md hover:shadow-lg transition-shadow cursor-pointer" onClick={() => onPageChange('sessions')}>
                            <div className="text-center">
                                <Play className="w-12 h-12 text-blue-600 mx-auto mb-4" />
                                <h3 className="text-lg font-semibold text-gray-900 mb-2">Sessions</h3>
                                <p className="text-gray-600 text-sm">Cr√©er ou reprendre une session de rem√©moration</p>
                            </div>
                        </div>
                        <div className="bg-white p-6 rounded-lg shadow-md hover:shadow-lg transition-shadow cursor-pointer" onClick={() => onPageChange('memories')}>
                            <div className="text-center">
                                <Cloud className="w-12 h-12 text-green-600 mx-auto mb-4" />
                                <h3 className="text-lg font-semibold text-gray-900 mb-2">M√©moires</h3>
                                <p className="text-gray-600 text-sm">Explorer le blog Mastodon et les photos</p>
                            </div>
                        </div>
                        <div className="bg-white p-6 rounded-lg shadow-md hover:shadow-lg transition-shadow cursor-pointer" onClick={() => onPageChange('settings')}>
                            <div className="text-center">
                                <Settings className="w-12 h-12 text-purple-600 mx-auto mb-4" />
                                <h3 className="text-lg font-semibold text-gray-900 mb-2">R√©glages</h3>
                                <p className="text-gray-600 text-sm">Configuration et pr√©f√©rences</p>
                            </div>
                        </div>
                    </div>
                )}
            </div>
        );
		const GamesPage = ({ currentUser, onPageChange, onGameSelect }) => (
    <div className="space-y-6 fade-in">
        <div className="flex justify-between items-center">
            <h2 className="text-2xl font-bold text-amber-900">Catalogue de jeux de rem√©moration</h2>
            <button
                onClick={() => {
                    const randomGame = GAMES[Math.floor(Math.random() * GAMES.length)];
                    onGameSelect(randomGame);
                }}
                className="flex items-center space-x-2 px-4 py-2 bg-purple-500 hover:bg-purple-600 text-white rounded-lg"
            >
                <Shuffle className="w-4 h-4" />
                <span>Jeu au hasard</span>
            </button>
        </div>

        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
            {GAMES.map(game => {
                const IconComponent = game.icon;
                return (
                    <button
                        key={game.id}
                        onClick={() => onGameSelect(game)}
                        className="p-6 border-2 border-gray-200 rounded-lg hover:border-amber-300 hover:bg-amber-50 transition-all text-left group"
                    >
                        <div className="flex items-start space-x-4">
                            <IconComponent className="w-8 h-8 text-amber-600 mt-1 flex-shrink-0" />
                            <div className="flex-1">
                                <div className="flex justify-between items-start mb-2">
                                    <h3 className="font-semibold text-lg text-amber-900 group-hover:text-amber-800">
                                        {game.title}
                                    </h3>
                                    <span className="text-xs bg-gray-100 px-2 py-1 rounded text-gray-600">
                                        {game.duration}
                                    </span>
                                </div>
                                <p className="text-gray-600 text-sm leading-relaxed mb-2">
                                    {game.description}
                                </p>
                                <div className="flex justify-between items-center">
                                    <div className="text-xs text-amber-600 font-medium">
                                        {game.type}
                                    </div>
                                    <div className="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded">
                                        ‚ñ∂Ô∏è Cr√©er session
                                    </div>
                                </div>
                            </div>
                        </div>
                    </button>
                );
            })}
        </div>

        <div className="bg-amber-50 border border-amber-200 rounded-lg p-4">
            <h3 className="font-semibold text-amber-900 mb-2">üí° Comment √ßa marche ?</h3>
            <p className="text-amber-700 text-sm">
                Choisissez un jeu pour cr√©er une nouvelle session de rem√©moration. 
                Vous pourrez ensuite √©changer vos souvenirs dans un format de chat convivial.
            </p>
        </div>
    </div>
);




        const SessionsPage = ({ currentUser }) => {
            const {
                currentSession, setCurrentSession,
                sessionView, setSessionView,
                sessions,
                createSession,
                updateSession,
                deleteSession,
                getGameIcon,
                renderGameIcon
            } = useSessionState();

            const [newMessageContent, setNewMessageContent] = React.useState('');
            const [editingMessage, setEditingMessage] = React.useState(null);
            const [editContent, setEditContent] = React.useState('');
            const messagesEndRef = React.useRef(null);

            // Auto-scroll vers le bas des messages
            React.useEffect(() => {
                if (currentSession?.notes && messagesEndRef.current) {
                    messagesEndRef.current.scrollIntoView({ behavior: 'smooth' });
                }
            }, [currentSession?.notes?.length]);

            const formatTime = (dateString) => {
                return new Date(dateString).toLocaleTimeString('fr-FR', { 
                    hour: '2-digit',
                    minute: '2-digit'
                });
            };

            const formatDate = (dateString) => {
                return new Date(dateString).toLocaleDateString('fr-FR', { 
                    day: 'numeric', 
                    month: 'short',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            };

            const sendMessage = () => {
                if (!newMessageContent.trim() || !currentSession) return;

                const newMessage = {
                    id: Date.now(),
                    content: newMessageContent.trim(),
                    author: currentUser,
                    timestamp: new Date().toISOString()
                };

                const updatedSession = {
                    ...currentSession,
                    notes: [...(currentSession.notes || []), newMessage]
                };

                updateSession(updatedSession);
                setNewMessageContent('');
            };

            const startEditMessage = (message) => {
                setEditingMessage(message.id);
                setEditContent(message.content);
            };

            const saveEditMessage = (messageId) => {
                if (!editContent.trim() || !currentSession) return;

                const updatedSession = {
                    ...currentSession,
                    notes: (currentSession.notes || []).map(note => 
                        note.id === messageId 
                            ? { ...note, content: editContent.trim(), edited: true }
                            : note
                    )
                };

                updateSession(updatedSession);
                setEditingMessage(null);
                setEditContent('');
            };

            const cancelEdit = () => {
                setEditingMessage(null);
                setEditContent('');
            };

            const deleteMessage = (messageId) => {
                if (!confirm('Supprimer ce message ?') || !currentSession) return;

                const updatedSession = {
                    ...currentSession,
                    notes: (currentSession.notes || []).filter(note => note.id !== messageId)
                };

                updateSession(updatedSession);
            };

            const inviteOtherUser = () => {
                const otherUser = currentUser === 'tom' ? 'lambert' : 'tom';
                alert(`üì® Invitation envoy√©e √† ${USERS[otherUser]?.name} !`);
                
                const updatedSession = {
                    ...currentSession,
                    status: 'pending',
                    lastPingBy: currentUser
                };
                updateSession(updatedSession);
            };

            const pauseSession = () => {
                const updatedSession = {
                    ...currentSession,
                    status: 'paused'
                };
                updateSession(updatedSession);
            };

            const closeSession = () => {
                console.log('closeSession appel√©e pour session:', currentSession?.id);
                
                if (!currentSession) {
                    console.warn('closeSession: aucune session courante');
                    return;
                }
                
                const updatedSession = {
                    ...currentSession,
                    status: 'completed'
                };
                
                console.log('Session √† fermer:', updatedSession);
                
                updateSession(updatedSession);
                setSessionView('list');
            };

            // Vue: Liste des sessions
            if (sessionView === 'list') {
                return (
                    <div className="space-y-6 fade-in">
                        <div className="flex justify-between items-center">
                            <h2 className="text-2xl font-bold text-amber-900">Sessions de rem√©moration</h2>
                            <button
    							onClick={() => onPageChange('games')}
    							className="flex items-center space-x-2 px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg"
							>
   								<Plus className="w-4 h-4" />
    							<span>Choisir un jeu</span>
							</button>
                        </div>

                        {sessions.length === 0 ? (
                            <div className="text-center py-12">
                                <Play className="w-16 h-16 text-gray-300 mx-auto mb-4" />
                                <h3 className="text-lg font-medium text-gray-900 mb-2">Aucune session</h3>
                                <p className="text-gray-600 mb-6">Cr√©ez votre premi√®re session de rem√©moration</p>
                                <button
                                    onClick={() => setSessionView('catalog')}
                                    className="px-6 py-3 bg-amber-500 hover:bg-amber-600 text-white rounded-lg font-medium"
                                >
                                    Choisir un jeu
                                </button>
                            </div>
                        ) : (
                            <div className="space-y-3">
                                {sessions.map((session) => {
                                    const statusStyles = {
                                        active: { bg: 'bg-green-100', text: 'text-green-800', dot: 'bg-green-500' },
                                        paused: { bg: 'bg-orange-100', text: 'text-orange-800', dot: 'bg-orange-500' },
                                        pending: { bg: 'bg-blue-100', text: 'text-blue-800', dot: 'bg-blue-500' },
                                        completed: { bg: 'bg-gray-100', text: 'text-gray-800', dot: 'bg-gray-500' }
                                    };
                                    const style = statusStyles[session.status] || statusStyles.active;

                                    return (
                                        <div
                                            key={session.id}
                                            className="bg-white p-4 rounded-lg border border-gray-200 hover:border-gray-300 transition-colors cursor-pointer"
                                            onClick={() => {
                                                setCurrentSession(session);
                                                setSessionView('active');
                                            }}
                                        >
                                            <div className="flex items-center justify-between">
                                                <div className="flex items-center space-x-3">
												{renderGameIcon(session.gameId, "w-6 h-6 text-amber-600")}                                                    <div>
                                                        <div className="font-medium text-gray-900">{session.gameTitle}</div>
                                                        <div className="text-sm text-gray-600">
                                                            {USERS[session.user]?.name} ‚Ä¢ {formatDate(session.updatedAt)} ‚Ä¢ {(session.notes || []).length} note(s)
                                                        </div>
                                                    </div>
                                                </div>
                                                <div className="flex items-center space-x-2">
                                                    <div className={`flex items-center space-x-2 px-3 py-1 rounded-full ${style.bg} ${style.text}`}>
                                                        <div className={`w-2 h-2 rounded-full ${style.dot}`}></div>
                                                        <span className="text-sm font-medium capitalize">{session.status}</span>
                                                    </div>
                                                    <ChevronRight className="w-4 h-4 text-gray-400" />
                                                </div>
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        )}
                    </div>
                );
            }

            

            // Vue: Session active
            if (sessionView === 'active' && currentSession) {
                return (
                    <div className="flex flex-col h-screen max-h-[80vh] fade-in">
                        {/* Header */}
                        <div className="flex items-center space-x-4 mb-4">
                            <button
                                onClick={() => setSessionView('list')}
                                className="flex items-center space-x-2 px-3 py-2 text-gray-600 hover:text-gray-800 hover:bg-gray-100 rounded-lg"
                            >
                                <ArrowLeft className="w-4 h-4" />
                                <span>Sessions</span>
                            </button>
                        </div>

                        {/* Session Header */}
                        <div className="bg-amber-50 border border-amber-200 rounded-lg p-4 mb-4 flex-shrink-0">
                            <div className="flex items-start space-x-3">
                                {renderGameIcon(currentSession.gameId, "w-8 h-8 text-amber-600")}
                                <div className="flex-1">
                                    <h2 className="text-lg font-bold text-amber-900 mb-1">
                                        {currentSession.gameTitle || 'Session sans titre'}
                                    </h2>
                                    <p className="text-amber-700 text-sm mb-2">
                                        {currentSession.gameDescription || 'Aucune description'}
                                    </p>
                                    <div className="flex items-center space-x-3 text-xs text-amber-600">
                                        <span>{currentSession.gameDuration || 'Dur√©e inconnue'}</span>
                                        <span>‚Ä¢</span>
                                        <span>{formatDate(currentSession.createdAt)}</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* Messages Container */}
                        <div className="flex-1 bg-gray-50 rounded-lg border overflow-y-auto p-4 space-y-3">
                            {(!currentSession.notes || currentSession.notes.length === 0) ? (
                                <div className="text-center py-12 text-gray-500">
                                    <BookOpen className="w-12 h-12 mx-auto mb-3 opacity-30" />
                                    <p className="text-lg font-medium mb-2">Aucun message</p>
                                    <p className="text-sm">Commencez la conversation en √©crivant vos souvenirs !</p>
                                </div>
                            ) : (
                                (currentSession.notes || []).map((message, index) => {
                                    const isOwnMessage = message.author === currentUser;
                                    const isEditing = editingMessage === message.id;
                                    
                                    // Couleurs des bulles selon l'utilisateur
                                    const getBubbleStyle = (author) => {
                                        if (author === 'tom') return 'bg-blue-500 text-white';
                                        if (author === 'lambert') return 'bg-green-500 text-white'; 
                                        return 'bg-amber-500 text-white'; // duo
                                    };

                                    return (
                                        <div key={message.id} className={`flex ${isOwnMessage ? 'justify-end' : 'justify-start'}`}>
                                            <div className={`max-w-[70%] ${isOwnMessage ? 'order-2' : 'order-1'}`}>
                                                {/* Nom de l'utilisateur (seulement si ce n'est pas soi) */}
                                                {!isOwnMessage && (
                                                    <div className="text-xs text-gray-500 mb-1 px-3">
                                                        {USERS[message.author]?.name}
                                                    </div>
                                                )}
                                                
                                                <div className={`rounded-2xl px-4 py-3 ${getBubbleStyle(message.author)} ${isOwnMessage ? 'rounded-br-md' : 'rounded-bl-md'} relative group`}>
                                                    {isEditing ? (
                                                        <div className="space-y-2">
                                                            <textarea
                                                                value={editContent}
                                                                onChange={(e) => setEditContent(e.target.value)}
                                                                className="w-full bg-white text-gray-800 rounded p-2 text-sm resize-none"
                                                                rows="3"
                                                                autoFocus
                                                            />
                                                            <div className="flex space-x-2">
                                                                <button
                                                                    onClick={() => saveEditMessage(message.id)}
                                                                    className="px-3 py-1 bg-white text-green-600 rounded text-xs font-medium"
                                                                >
                                                                    Sauver
                                                                </button>
                                                                <button
                                                                    onClick={cancelEdit}
                                                                    className="px-3 py-1 bg-white text-gray-600 rounded text-xs font-medium"
                                                                >
                                                                    Annuler
                                                                </button>
                                                            </div>
                                                        </div>
                                                    ) : (
                                                        <>
                                                            <p className="text-sm leading-relaxed whitespace-pre-wrap">
                                                                {message.content}
                                                            </p>
                                                            {message.edited && (
                                                                <span className="text-xs opacity-70 italic">modifi√©</span>
                                                            )}
                                                            
                                                            {/* Menu d'actions (seulement pour ses propres messages) */}
                                                            {isOwnMessage && (
                                                                <div className="absolute top-1 right-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                                                    <button
                                                                        onClick={() => startEditMessage(message)}
                                                                        className="p-1 bg-white bg-opacity-20 hover:bg-opacity-40 rounded text-xs"
                                                                        title="Modifier"
                                                                    >
                                                                        <Edit className="w-3 h-3" />
                                                                    </button>
                                                                    <button
                                                                        onClick={() => deleteMessage(message.id)}
                                                                        className="p-1 bg-white bg-opacity-20 hover:bg-opacity-40 rounded text-xs ml-1"
                                                                        title="Supprimer"
                                                                    >
                                                                        <Trash2 className="w-3 h-3" />
                                                                    </button>
                                                                </div>
                                                            )}
                                                        </>
                                                    )}
                                                </div>
                                                
                                                {/* Timestamp */}
                                                <div className={`text-xs text-gray-500 mt-1 px-3 ${isOwnMessage ? 'text-right' : 'text-left'}`}>
                                                    {formatTime(message.timestamp)}
                                                </div>
                                            </div>
                                        </div>
                                    );
                                })
                            )}
                            <div ref={messagesEndRef} />
                        </div>

                        {/* Message Input */}
                        <div className="mt-4 flex-shrink-0">
                            <div className="bg-white border border-gray-300 rounded-lg p-3">
                                <div className="flex space-x-3">
                                    <textarea
                                        value={newMessageContent}
                                        onChange={(e) => setNewMessageContent(e.target.value)}
                                        placeholder="√âcrivez vos souvenirs, r√©flexions, d√©tails qui vous reviennent..."
                                        className="flex-1 resize-none border-none focus:outline-none text-gray-800"
                                        rows="3"
                                        onKeyDown={(e) => {
                                            if (e.key === 'Enter' && !e.shiftKey) {
                                                e.preventDefault();
                                                sendMessage();
                                            }
                                        }}
                                    />
                                    <button
                                        onClick={sendMessage}
                                        disabled={!newMessageContent.trim()}
                                        className="self-end px-4 py-2 bg-blue-500 hover:bg-blue-600 disabled:bg-gray-300 text-white rounded-lg disabled:cursor-not-allowed flex items-center space-x-2"
                                    >
                                        <Send className="w-4 h-4" />
                                        <span>Envoyer</span>
                                    </button>
                                </div>
                                <div className="flex justify-between items-center mt-2 text-xs text-gray-500">
                                    <span>{newMessageContent.length} caract√®res</span>
                                    <span>Shift+Entr√©e pour nouvelle ligne</span>
                                </div>
                            </div>
                        </div>

                        {/* Session Actions */}
                        <div className="flex justify-center space-x-3 mt-4 pt-3 border-t border-gray-200 flex-shrink-0">
                            {currentUser !== 'duo' && (
                                <button
                                    onClick={inviteOtherUser}
                                    className="flex items-center space-x-2 px-3 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg text-sm"
                                >
                                    <Send className="w-4 h-4" />
                                    <span>Inviter</span>
                                </button>
                            )}
                            <button
                                onClick={pauseSession}
                                className="flex items-center space-x-2 px-3 py-2 bg-orange-500 hover:bg-orange-600 text-white rounded-lg text-sm"
                            >
                                <Pause className="w-4 h-4" />
                                <span>Pause</span>
                            </button>
                            <button
                                onClick={closeSession}
                                className="flex items-center space-x-2 px-3 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-lg text-sm"
                            >
                                <Play className="w-4 h-4" />
                                <span>Terminer</span>
                            </button>
                        </div>
                    </div>
                );
            }

            return null;
        };

        const MemoriesPage = () => (
            <div className="space-y-6 fade-in">
                <h2 className="text-2xl font-bold text-amber-900">M√©moires du voyage</h2>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div className="bg-gradient-to-br from-blue-50 to-indigo-50 p-6 rounded-lg border border-blue-200">
                        <div className="text-center">
                            <Cloud className="w-12 h-12 text-blue-600 mx-auto mb-4" />
                            <h3 className="text-lg font-semibold text-blue-900 mb-2">Blog Mastodon</h3>
                            <p className="text-blue-700 text-sm mb-4">275 posts du voyage √† explorer</p>
                            <div className="bg-blue-100 p-3 rounded text-blue-800 text-sm">
                                üöß Import et navigation - Prochaine √©tape
                            </div>
                        </div>
                    </div>
                    <div className="bg-gradient-to-br from-green-50 to-emerald-50 p-6 rounded-lg border border-green-200">
                        <div className="text-center">
                            <Camera className="w-12 h-12 text-green-600 mx-auto mb-4" />
                            <h3 className="text-lg font-semibold text-green-900 mb-2">Photos</h3>
                            <p className="text-green-700 text-sm mb-4">2000+ photos organis√©es par jour</p>
                            <div className="bg-green-100 p-3 rounded text-green-800 text-sm">
                                üöß API DirectoryPicker - Prochaine √©tape
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        );

        const SettingsPage = ({ onReset }) => (
            <div className="space-y-6 fade-in">
                <h2 className="text-2xl font-bold text-amber-900">R√©glages</h2>
                <div className="bg-white p-6 rounded-lg shadow-md space-y-4">
                    <div className="bg-red-50 border border-red-200 p-4 rounded-lg">
                        <h3 className="text-lg font-semibold text-red-900 mb-2">üö® Bug page blanche d√©tect√©</h3>
                        <p className="text-red-700 mb-4">
                            Des sessions corrompues causent des erreurs. Un reset est n√©cessaire pour corriger le probl√®me.
                        </p>
                        <button 
                            onClick={() => {
                                if (confirm('‚ö†Ô∏è RESET COMPLET n√©cessaire pour corriger le bug !\n\nCeci va effacer toutes les sessions et donn√©es, mais corrigera d√©finitivement le probl√®me de page blanche.\n\nContinuer ?')) {
                                    onReset();
                                    alert('‚úÖ Reset effectu√© ! Le bug est corrig√©.');
                                    window.location.reload();
                                }
                            }}
                            className="px-6 py-3 bg-red-600 hover:bg-red-700 text-white rounded-lg text-lg font-medium"
                        >
                            üîß RESET CORRECTIF
                        </button>
                    </div>
                    
                    <div>
                        <h3 className="text-lg font-semibold text-gray-900 mb-2">Donn√©es</h3>
                        <button 
                            onClick={() => {
                                if (confirm('‚ö†Ô∏è Effacer toutes les donn√©es sauvegard√©es (sessions, utilisateur, etc.) ?')) onReset();
                            }}
                            className="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg text-sm font-medium"
                        >
                            üóëÔ∏è Reset complet
                        </button>
                    </div>
                    <div className="pt-4 border-t border-gray-200">
                        <h4 className="font-medium text-gray-700 mb-2">Stockage actuel</h4>
                        <div className="text-sm text-gray-600 space-y-1">
                            <div>Utilisateur: {Storage.get('currentUser') || 'Non d√©fini'}</div>
                            <div>Sessions: {Storage.get('sessions', []).length} session(s) sauvegard√©e(s)</div>
                        </div>
                    </div>
                </div>
            </div>
        );

        // ===== MAIN APP =====
        const MemoireMekong = () => {
            const {
                currentPage, setCurrentPage,
                currentUser, setCurrentUser,
                resetApp
            } = useAppState();

            return (
                <div className="min-h-screen bg-gradient-to-br from-amber-50 to-orange-100 p-4">
                    <div className="max-w-6xl mx-auto">
                        {/* Header */}
						<div className="text-center mb-4">
    						<h1 className="text-2xl md:text-3xl font-bold text-amber-900">üêò M√©moire du M√©kong</h1>
    						<p className="text-xs text-amber-600 mt-1">V0.3.0</p>
						</div>

                        {/* Navigation */}
                        <Navigation 
                            currentPage={currentPage}
                            currentUser={currentUser}
                            onPageChange={setCurrentPage}
                            onUserChange={setCurrentUser}
                        />

                        {/* Main Content */}
                        <div className="bg-white/80 backdrop-blur rounded-xl shadow-lg p-6">
                            {currentPage === 'home' && (
                                <HomePage 
                                    currentUser={currentUser}
                                    onUserChange={setCurrentUser}
                                    onPageChange={setCurrentPage}
                                />
                            )}
							{currentPage === 'games' && (
    							<GamesPage 
        							currentUser={currentUser}
        							onPageChange={setCurrentPage}
        							onGameSelect={(game) => {
            							// Cr√©er session et rediriger vers Sessions
            							setCurrentPage('sessions');
            							// La logique de cr√©ation sera g√©r√©e dans SessionsPage
        							}}
    							/>
							)}
                            {currentPage === 'sessions' && <SessionsPage currentUser={currentUser} />}
                            {currentPage === 'memories' && <MemoriesPage />}
                            {currentPage === 'settings' && <SettingsPage onReset={resetApp} />}
                        </div>

                        {/* Footer */}
                        <div className="text-center mt-6 text-amber-700 text-sm">
                            <p>üêò Un voyage, deux m√©moires, mille souvenirs üêò</p>
                            <p className="text-xs opacity-75 mt-1">
                                ‚úÖ Debug renforc√© + Logs console ‚Ä¢ ‚è≥ Photos + Mastodon
                            </p>
                        </div>
                    </div>
                </div>
            );
        };

        // ===== RENDER =====
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(React.createElement(MemoireMekong));
    </script>
</body>
</html>
